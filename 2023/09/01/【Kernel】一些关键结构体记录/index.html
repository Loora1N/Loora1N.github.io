<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ã€Kernelã€‘ä¸€äº›trickè®°å½•ï¼ˆæŒç»­æ›´æ–°ï¼‰ | é·ºé›¨ã®Blog</title>

  
  <meta name="author" content="Loora1N">
  

  
  <meta name="description" content="Blog of Loora1N">
  

  
  
  <meta name="keywords" content="">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="ã€Kernelã€‘ä¸€äº›trickè®°å½•ï¼ˆæŒç»­æ›´æ–°ï¼‰"/>

  <meta property="og:site_name" content="é·ºé›¨ã®Blog"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="é·ºé›¨ã®Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">é·ºé›¨ã®Blog</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>ã€Kernelã€‘ä¸€äº›trickè®°å½•ï¼ˆæŒç»­æ›´æ–°ï¼‰</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a target="_blank" href="//2023/09/01/ã€Kernelã€‘ä¸€äº›å…³é”®ç»“æ„ä½“è®°å½•/" rel="bookmark noopener">
        <time class="entry-date published" datetime="2023-09-01T08:22:35.679Z">
          2023-09-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="pt-regs"><a href="#pt-regs" class="headerlink" title="pt_regs"></a>pt_regs</h2><p>ç”¨äºä¿å­˜<strong>ç”¨æˆ·æ€â€“&gt;å†…æ ¸æ€</strong>åˆ‡æ¢æ—¶çš„ç”¨æˆ·æ€ä¿¡æ¯ï¼Œåœ¨å†…æ ¸æ€è¿”å›æ—¶ä¼šä»<code>pt_regs</code>æ¢å¤æ•°æ®ã€‚å› è€Œè‹¥æˆ‘ä»¬èƒ½æ§åˆ¶rspåˆ°è¾¾æ­¤ä½ç½®ï¼Œå³å¯ä»¥ä½¿ç”¨ç”¨æˆ·æ€å¯„å­˜å™¨å€¼è¾…åŠ©å®ç°ROP</p>
<p><img src="/img/article/ktrick/t01bacb0bd7eee5eeaa.png" alt="img"></p>
<h2 id="list-headç»“æ„ä½“"><a href="#list-headç»“æ„ä½“" class="headerlink" title="list_headç»“æ„ä½“"></a>list_headç»“æ„ä½“</h2><p>ç®€å•çš„å†…æ ¸åŒé“¾è¡¨ç»“æ„ï¼Œåœ¨å†…æ ¸ä¸­ç»å¸¸ä½œä¸ºå®ç°åŒé“¾è¡¨ç»“æ„çš„åŸºç¡€ï¼Œå®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//	https://elixir.bootlin.com/linux/latest/source/include/linux/types.h#L184</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="setxattrç³»ç»Ÿè°ƒç”¨"><a href="#setxattrç³»ç»Ÿè°ƒç”¨" class="headerlink" title="setxattrç³»ç»Ÿè°ƒç”¨"></a>setxattrç³»ç»Ÿè°ƒç”¨</h2><blockquote>
<p>ä»a3âœŒçš„d3kheapä¸­å­¦åˆ°çš„ä¸œè¥¿ï¼Œa3âœŒä¹Ÿå¤ªè¶…äººäº†å§ï¼ï¼ï¼åŸæ–‡é“¾æ¥å¦‚ä¸‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/">ã€CTF.0x06ã€‘D^ 3CTF2022 d3kheap å‡ºé¢˜æ‰‹è®° - arttnba3â€™s blog</a></p>
</blockquote>
<p>setxattr æ˜¯ä¸€ä¸ªååˆ†ç‹¬ç‰¹çš„ç³»ç»Ÿè°ƒç”¨æ—ï¼ŒæŠ›å¼€å…¶æœ¬èº«çš„åŠŸèƒ½ï¼Œåœ¨ kernel çš„åˆ©ç”¨å½“ä¸­ä»–å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›<strong>è¿‘ä¹ä»»æ„å¤§å°çš„å†…æ ¸ç©ºé—´ object åˆ†é…</strong></p>
<p>è§‚å¯Ÿsetxattræºç ï¼Œå‘ç°å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr()</span><br><span class="line">    path_setxattr()</span><br><span class="line">        setxattr()</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>setxattr()</code>å‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span></span><br><span class="line"><span class="title function_">setxattr</span><span class="params">(<span class="keyword">struct</span> dentry *d, <span class="type">const</span> <span class="type">char</span> __user *name, <span class="type">const</span> <span class="type">void</span> __user *value,</span></span><br><span class="line"><span class="params">     <span class="type">size_t</span> size, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//,..</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ value å’Œ size éƒ½æ˜¯ç”±æˆ‘ä»¬æ¥æŒ‡å®šçš„ï¼Œå³<strong>æˆ‘ä»¬å¯ä»¥åˆ†é…ä»»æ„å¤§å°çš„ object å¹¶å‘å…¶ä¸­å†™å…¥å†…å®¹</strong>ï¼Œå®Œæˆå†™å…¥ä¹‹åè¯¥ object åˆä¼šé€šè¿‡ kvfree è¢«é‡Šæ”¾æ‰ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡ setxattr <strong>å¤šæ¬¡ä¿®æ”¹ victim çš„å†…å®¹</strong></p>
<h2 id="msg-queueæ¶ˆæ¯é˜Ÿåˆ—"><a href="#msg-queueæ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="msg_queueæ¶ˆæ¯é˜Ÿåˆ—"></a>msg_queueæ¶ˆæ¯é˜Ÿåˆ—</h2><blockquote>
<p>åŒæ ·æ¥è‡ªa3âœŒçš„blogï¼Œ a3âœŒç®€ç›´æ˜¯æˆ‘Kernelçš„å¯è’™è€å¸ˆğŸ˜­ğŸ˜­ğŸ˜­</p>
<p><a target="_blank" rel="noopener" href="https://arttnba3.cn/2022/03/08/CTF-0X06-D3CTF2022_D3KHEAP/">ã€CTF.0x06ã€‘D^ 3CTF2022 d3kheap å‡ºé¢˜æ‰‹è®° - arttnba3â€™s blog</a></p>
</blockquote>
<p>The syscall about system V message queue</p>
<ul>
<li>msggetï¼šcreate a msg queue</li>
<li>msgsndï¼šsend msg to a msg queue</li>
<li>msgrcvï¼šrecive msg from a msg queue</li>
</ul>
<p>System will create a structure named <strong>msg_queue</strong> when we create a message queue. Here is the definition of this structure.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msq_queue structure for each present queue on the system */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> <span class="title">q_perm</span>;</span></span><br><span class="line">	<span class="type">time64_t</span> q_stime;		<span class="comment">/* last msgsnd time */</span></span><br><span class="line">	<span class="type">time64_t</span> q_rtime;		<span class="comment">/* last msgrcv time */</span></span><br><span class="line">	<span class="type">time64_t</span> q_ctime;		<span class="comment">/* last change time */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> q_cbytes;		<span class="comment">/* current number of bytes on queue */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> q_qnum;		<span class="comment">/* number of messages in queue */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> q_qbytes;		<span class="comment">/* max number of bytes on queue */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lspid</span>;</span>		<span class="comment">/* pid of last msgsnd */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">q_lrpid</span>;</span>		<span class="comment">/* last receive pid */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_messages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_receivers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">q_senders</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>When we try to call <code>msgsnd</code> to send a message to a specified message queue, such a srturcture is created in kernel space:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">	<span class="type">long</span> m_type;</span><br><span class="line">	<span class="type">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="type">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å®é™…ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="/img/article/ktrick/5IcVxRaFQtg3HCW.png" alt="image.png"></p>
<hr>
<blockquote>
<p>ä¸‹é¢è¿™äº›ç•™ä¸ªå‘ï¼Œæœ‰ç©ºè¡¥ä¸Š</p>
</blockquote>
<h2 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h2><h2 id="tty-struct"><a href="#tty-struct" class="headerlink" title="tty struct"></a>tty struct</h2><h2 id="seq-operation"><a href="#seq-operation" class="headerlink" title="seq operation"></a>seq operation</h2>
      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2023 Loora1N
    
  </p>
</footer>
    
    
  </div>
</div>
<!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?Loora1N";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="Loora1N";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/about/'){
                console.log('å·²æŒ‚è½½github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // æ— æŠ¥é”™ï¼Œä½†ä¸å½±å“ä½¿ç”¨(æ”¯æŒpjaxè·³è½¬)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // æœ‰æŠ¥é”™ï¼Œä½†ä¸å½±å“ä½¿ç”¨(æ”¯æŒpjaxè·³è½¬)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body>
</html>