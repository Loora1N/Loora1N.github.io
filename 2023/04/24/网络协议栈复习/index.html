

<!DOCTYPE html>
<html lang="zh-CN" >



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon/duck.png">
  <link rel="icon" href="/img/icon/duck.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#f58f98">
  <meta name="author" content="Loora1N">
  <meta name="keywords" content="">
  
    <meta name="description" content="å‚è€ƒæ•™æã€ŠTCP&#x2F;IPè¯¦è§£ å·2ï¼šå®ç°ã€‹ï¼Œæ–‡å†…ç¤ºæ„å›¾å¤§å¤šå–è‡ªè¯¥æ•™æã€‚æœ¬æ–‡ä¸ºå¤ä¹ æ—¶è‡ªè¡Œæ€»ç»“ï¼Œéš¾å…å­˜åœ¨ä¸å…¨æˆ–è€…é”™è¯¯ï¼Œæ±‚æ±‚å¤§ä¼™è½»å–·ã€‚å¦‚æœ‰é—®é¢˜å¯ä»¥ç•™è¨€åœ¨æ–‡æœ«è¯„è®ºåŒºï¼Œæˆ–è€…ç›´æ¥ç§èŠï¼Œæˆ‘ä¼šåŠæ—¶æ›´æ”¹æ–‡ç« å†…å®¹ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ç½‘ç»œåè®®æ ˆCH1-CH3">
<meta property="og:url" content="http://loora1n.github.io/2023/04/24/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0/index.html">
<meta property="og:site_name" content="é·ºé›¨ã®Blog">
<meta property="og:description" content="å‚è€ƒæ•™æã€ŠTCP&#x2F;IPè¯¦è§£ å·2ï¼šå®ç°ã€‹ï¼Œæ–‡å†…ç¤ºæ„å›¾å¤§å¤šå–è‡ªè¯¥æ•™æã€‚æœ¬æ–‡ä¸ºå¤ä¹ æ—¶è‡ªè¡Œæ€»ç»“ï¼Œéš¾å…å­˜åœ¨ä¸å…¨æˆ–è€…é”™è¯¯ï¼Œæ±‚æ±‚å¤§ä¼™è½»å–·ã€‚å¦‚æœ‰é—®é¢˜å¯ä»¥ç•™è¨€åœ¨æ–‡æœ«è¯„è®ºåŒºï¼Œæˆ–è€…ç›´æ¥ç§èŠï¼Œæˆ‘ä¼šåŠæ—¶æ›´æ”¹æ–‡ç« å†…å®¹ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://loora1n.github.io/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424174856553.png">
<meta property="article:published_time" content="2023-04-24T14:34:57.572Z">
<meta property="article:modified_time" content="2023-04-24T14:34:57.572Z">
<meta property="article:author" content="Loora1N">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://loora1n.github.io/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424174856553.png">
  
  
  
  <title>ç½‘ç»œåè®®æ ˆCH1-CH3 - é·ºé›¨ã®Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  



  
<link rel="stylesheet" href="/css/fluid-extention.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"loora1n.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"â¡"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"lftEbNU4XPuR5dgHNV3WdWxP-gzGzoHsz","app_key":"b3uLUVGLeOWDwREWHMBr0jo9","server_url":"https://lftebnu4.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>é·ºé›¨ã®Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/3.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ç½‘ç»œåè®®æ ˆCH1-CH3"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-24 22:34" pubdate>
          2023å¹´4æœˆ24æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8.4k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          71 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          é˜…è¯»é‡ <span id="leancloud-page-views"></span>
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ç½‘ç»œåè®®æ ˆCH1-CH3</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>å‚è€ƒæ•™æã€ŠTCP&#x2F;IPè¯¦è§£ å·2ï¼šå®ç°ã€‹ï¼Œæ–‡å†…ç¤ºæ„å›¾å¤§å¤šå–è‡ªè¯¥æ•™æã€‚æœ¬æ–‡ä¸ºå¤ä¹ æ—¶è‡ªè¡Œæ€»ç»“ï¼Œéš¾å…å­˜åœ¨ä¸å…¨æˆ–è€…é”™è¯¯ï¼Œæ±‚æ±‚å¤§ä¼™è½»å–·ã€‚å¦‚æœ‰é—®é¢˜å¯ä»¥ç•™è¨€åœ¨æ–‡æœ«è¯„è®ºåŒºï¼Œæˆ–è€…ç›´æ¥ç§èŠï¼Œæˆ‘ä¼šåŠæ—¶æ›´æ”¹æ–‡ç« å†…å®¹ã€‚</p>
</blockquote>
<h2 id="ç¬¬ä¸€ç« -æ¦‚è¿°"><a href="#ç¬¬ä¸€ç« -æ¦‚è¿°" class="headerlink" title="ç¬¬ä¸€ç«  æ¦‚è¿°"></a>ç¬¬ä¸€ç«  æ¦‚è¿°</h2><h3 id="åŸºæœ¬æ¡†æ¶"><a href="#åŸºæœ¬æ¡†æ¶" class="headerlink" title="åŸºæœ¬æ¡†æ¶"></a>åŸºæœ¬æ¡†æ¶</h3><h4 id="ç½‘ç»œè¾“å…¥è¾“å‡ºå±‚é—´æ¡†æ¶"><a href="#ç½‘ç»œè¾“å…¥è¾“å‡ºå±‚é—´æ¡†æ¶" class="headerlink" title="ç½‘ç»œè¾“å…¥è¾“å‡ºå±‚é—´æ¡†æ¶"></a>ç½‘ç»œè¾“å…¥è¾“å‡ºå±‚é—´æ¡†æ¶</h4><p>åŸºæœ¬æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢è¯¦ç»†è®¨è®ºè¾“å…¥è¾“å‡º</p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424174856553.png" alt="image-20230424174856553"></p>
<h4 id="UDPç¤ºä¾‹socketç¨‹åºæ¡†æ¶"><a href="#UDPç¤ºä¾‹socketç¨‹åºæ¡†æ¶" class="headerlink" title="UDPç¤ºä¾‹socketç¨‹åºæ¡†æ¶"></a>UDPç¤ºä¾‹socketç¨‹åºæ¡†æ¶</h4><blockquote>
<p>è¿™æ®µCä»£ç ä¹Ÿå……å½“åç»­æˆ‘ä»¬åˆ†æè¾“å…¥è¾“å‡ºæ—¶çš„ä¾‹å­</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment">* Send a UDP datagram to the daytime server on some other host,</span><br><span class="hljs-comment">* read the reply. and print the time and date on the server .</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>    <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>    <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>    <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>    <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>    <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>    <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span>    <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFFSIZE    150     <span class="hljs-comment">/* arbitrary size */</span></span><br><span class="hljs-type">int</span><br><span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">serv</span>;</span><br>    <span class="hljs-type">char</span> buff [BUFFSIZE] ;<br>    <span class="hljs-type">int</span> sockfd, n;<br>    <span class="hljs-keyword">if</span> ((sockfd = socket(PF_INET, SOCK_DGRAM,<span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<br>        err_sys (<span class="hljs-string">&quot; socket error&quot;</span>) ;<br>    <br>    bzero((<span class="hljs-type">char</span> *) &amp;serv, <span class="hljs-keyword">sizeof</span> (serv));<br>    <br>    serv.sin_family = AF_INET;<br>    serv.sin_addr.s_addr = inet_addr(<span class="hljs-string">&quot;140.252.1.32&quot;</span>);<br>    serv.sin_port = htons(<span class="hljs-number">13</span>);<br><br>    <span class="hljs-keyword">if</span> (sendto (sockfd, buff, BUFFSIZE,<span class="hljs-number">0</span>,<br>        (<span class="hljs-keyword">struct</span> sockaddr *) &amp;serv, <span class="hljs-keyword">sizeof</span>(serv)) != BUFFSIZE)<br>    err_sys (<span class="hljs-string">&quot;sendto error&quot;</span>);<br>    <br>    <span class="hljs-keyword">if</span> ((n = recvfrom(sockfd, buff, BUFFSIZE, <span class="hljs-number">0</span>,<br>        (<span class="hljs-keyword">struct</span> sockaddr *) <span class="hljs-literal">NULL</span>, (<span class="hljs-type">int</span> *) <span class="hljs-literal">NULL</span>))&lt; <span class="hljs-number">2</span>)<br>    err_sys(<span class="hljs-string">&quot;recvfrom error&quot;</span>);<br>    buff[n - <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;        <span class="hljs-comment">/* null terminate */</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;s\n&quot;</span>, buff);<br><br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="è¾“å‡ºæµç¨‹"><a href="#è¾“å‡ºæµç¨‹" class="headerlink" title="è¾“å‡ºæµç¨‹"></a>è¾“å‡ºæµç¨‹</h3><p>ä¸‹é¢è€ƒè™‘æ’å£å±‚è°ƒç”¨<code>sendto()</code>å‡½æ•°æ—¶å‘ç”Ÿçš„æµç¨‹</p>
<h4 id="mbufç»“æ„"><a href="#mbufç»“æ„" class="headerlink" title="mbufç»“æ„"></a>mbufç»“æ„</h4><p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424135820569.png" alt="ç”¨ä¸¤ä¸ªmbufæ¥å­˜å‚¨150å­—èŠ‚çš„æ•°æ®"></p>
<p>å¦‚å›¾æ˜¯ä¸€ä¸ªå«æœ‰150å­—èŠ‚çš„mbufåˆ†ç»„ã€‚å®è§‚æ¥çœ‹ï¼Œå¯ä»¥å‘ç°<code>mbuf</code>æ˜¯ç”±<code>m_next</code>æŒ‡é’ˆé“¾æ¥çš„å•é“¾è¡¨ï¼Œè¿™ç§å®‰æ’æ–¹å¼å«åš<strong>mbufé“¾è¡¨</strong>. </p>
<p>ç»†èŠ‚æ¥çœ‹å„ä¸ªæˆå‘˜å˜é‡åŠå…¶å«ä¹‰ï¼š</p>
<ul>
<li><code>m_next</code>ç”¨æ¥è¿æ¥ä¸‹ä¸€ä¸ª<code>mbuf</code></li>
<li><code>m_nextpkt</code>ç”¨æ¥è¿æ¥ä¸‹ä¸€ä¸ª<strong>mbufåˆ†ç»„</strong></li>
<li><code>m_len</code>æ ‡è¯†æ‰€åœ¨çš„<code>mbuf</code>åŒ…å«çš„<strong>dataæ•°æ®é•¿åº¦</strong></li>
<li><code>m_type</code>æ ‡è¯†æ‰€åœ¨<code>mbuf</code>çš„ç±»å‹</li>
<li><code>m_data</code>æŒ‡å‘æ‰€åœ¨<code>mbuf</code>çš„<strong>æ•°æ®å¼€å¤´åœ°å€</strong></li>
<li><code>m_flags</code>ç”¨æ¥æ ‡è¯†æ‰€åœ¨<code>mbuf</code>çš„ç±»å‹ï¼Œä½†ä¸åŒäº<code>m_type</code></li>
</ul>
<p>ä»¥åŠä¸¤ä¸ªç‰¹æ®Šçš„æˆå‘˜ï¼Œå…±åŒç»„æˆäº†<strong>mbufåˆ†ç»„é¦–éƒ¨</strong>ï¼Œå 8ä¸ªbyteã€‚åªæœ‰å½“mbufçš„<strong>flagsä¸ºM_PKTHDR</strong>æ—¶ï¼Œæ‰å¯ç”¨ï¼š</p>
<ul>
<li><code>m_pkthdr.len</code>ç”¨æ¥è¡¨ç¤ºæ•´ä¸ªåˆ†ç»„çš„dataé•¿åº¦</li>
<li><code>m_pkthdr.rcvif</code></li>
</ul>
<p>æ•´ä¸ªmbufçš„sizeä¸º128 byteï¼Œé™¤å»å‰é¢çš„æˆå‘˜å˜é‡å’Œé¦–éƒ¨çš„è¯å¯ä»¥å­˜å‚¨100å­—èŠ‚çš„æ•°æ®ï¼Œå¦‚æœä¸åŒ…å«mbufåˆ†ç»„é¦–éƒ¨ï¼Œåˆ™å¯ä»¥å­˜å‚¨108å­—èŠ‚ã€‚</p>
<h4 id="æ·»åŠ IPå’ŒUDPé¦–éƒ¨"><a href="#æ·»åŠ IPå’ŒUDPé¦–éƒ¨" class="headerlink" title="æ·»åŠ IPå’ŒUDPé¦–éƒ¨"></a>æ·»åŠ IPå’ŒUDPé¦–éƒ¨</h4><p>ä¸‹å›¾æ˜¯ä»¥ä¸€ä¸ª150å­—èŠ‚æ•°æ®çš„mbufï¼ŒåŠ å…¥IPå’ŒUDPé¦–éƒ¨åçš„mbufæƒ…å†µ</p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424142206955.png" alt="æ·»åŠ IPå’ŒUDPé¦–éƒ¨"></p>
<p>å…·ä½“æ¥è¯´ï¼Œå½“UDPè¾“å‡ºä¾‹ç¨‹è¢«è°ƒç”¨æ—¶ï¼š</p>
<ol>
<li>é¦–å…ˆè®²åŸæœ‰æŒ‡å‘150byteçš„mbufé“¾è¡¨çš„æŒ‡é’ˆä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’</li>
<li>ç„¶åæ–°å»ºä¸€ä¸ªå«æœ‰<strong>28å­—èŠ‚</strong>IPé¦–éƒ¨å’ŒUDPé¦–éƒ¨çš„mbuf</li>
<li>å°†æ–°å»ºçš„mbufçš„<code>m_next</code>åŸŸæŒ‡å‘åŸæœ‰ä¼ å…¥çš„mbufæŒ‡é’ˆ</li>
<li>å°†åŸæœ‰8byteçš„åˆ†ç»„é¦–éƒ¨copyåˆ°æ–°çš„é¦–éƒ¨</li>
</ol>
<blockquote>
<p>å¦å¤–éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ç¬¬4æ­¥ä¸­å°†åˆ†ç»„é¦–éƒ¨å¤åˆ¶åˆ°äº†æ–°çš„mbufä¸­ï¼Œé‚£ä¹ˆæ–°æ—§mbufçš„<strong>m_flags</strong>åŸŸä¹Ÿè¦è¿›è¡Œç›¸åº”çš„è®¾ç½®ã€‚</p>
</blockquote>
<p>äºæ˜¯æ–°çš„mbufæˆä¸ºäº†æ–°çš„åˆ†ç»„é¦–éƒ¨ï¼Œä¸”mbufé“¾è¡¨çš„æ€»é•¿åº¦ç”±2å˜3ï¼Œmbufåˆ†ç»„çš„æ•°æ®é•¿åº¦å¢åŠ äº†28ï¼Œå˜æˆäº†178byteã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<strong>åˆ†ç»„é¦–éƒ¨å’ŒIP&#x2F;UDPé¦–éƒ¨ä¹‹é—´å­˜åœ¨78å­—èŠ‚çš„ç©ºç¼º</strong>ï¼Œé€šè¿‡é€‚å½“çš„è°ƒæ•´<code>m_data</code>å’Œ<code>m_len</code>æˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­åŠ å…¥ä¹‹åçš„é¦–éƒ¨ï¼Œè€Œä¸éœ€è¦æ–°å»ºmbuf.</p>
<p>ä¹‹åç”±UDPä¾‹ç¨‹å¡«å†™UDPé¦–éƒ¨å’ŒIPé¦–éƒ¨çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼Œä¸”UDPæ£€éªŒå’Œè®¡ç®—åä¹Ÿä¼šå­˜å‚¨åœ¨è¿™é‡Œã€‚æ¥ç€ï¼ŒUDPè¾“å‡ºä¾‹ç¨‹è°ƒç”¨IPè¾“å‡ºä¾‹ç¨‹ï¼Œå¹¶æŠŠæ­¤mbufé“¾è¡¨çš„æŒ‡é’ˆä¼ é€’ç»™IPè¾“å‡ºä¾‹ç¨‹ã€‚UDPå’ŒIPé¦–éƒ¨å‰©ä½™çš„éƒ¨åˆ†ç”±IPè¾“å‡ºä¾‹ç¨‹è¿›è¡Œå¡«å†™ï¼Œå¦‚IPæ ¡éªŒå’Œç­‰ç­‰ã€‚</p>
<h4 id="ä»¥å¤ªç½‘è¾“å‡º"><a href="#ä»¥å¤ªç½‘è¾“å‡º" class="headerlink" title="ä»¥å¤ªç½‘è¾“å‡º"></a>ä»¥å¤ªç½‘è¾“å‡º</h4><p>åœ¨å®Œæˆä¸Šè¿°æ“ä½œåï¼ŒIPè¾“å‡ºä¾‹ç¨‹è°ƒç”¨ä»¥å¤ªç½‘æ¥å£å¹¶æŠŠmbufé“¾è¡¨ç»§ç»­ä¼ é€’ï¼Œä»¥å¤ªç½‘è¾“å‡ºå‡½æ•°æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å°†32ä¸ºIPåœ°å€è§£æä¸º48ä½6ä¸ªå­—èŠ‚çš„ä»¥å¤ªç½‘åœ°å€</li>
<li>å‘mbufé¦–éƒ¨ä¹‹å‰ç©ºå‡ºæ¥çš„åœ°æ–¹ï¼Œæ·»åŠ 14å­—èŠ‚çš„ä»¥å¤ªç½‘é¦–éƒ¨</li>
<li>å°†mbufæ”¾å…¥ä»¥å¤ªç½‘è¾“å…¥è¾“å‡ºé˜Ÿåˆ—é˜Ÿå°¾</li>
</ol>
<blockquote>
<p>14å­—èŠ‚çš„ä»¥å¤ªç½‘é¦–éƒ¨åŒ…å«ï¼š<strong>6å­—èŠ‚çš„ä»¥å¤ªç½‘æºåœ°å€ï¼Œ6å­—èŠ‚çš„ä»¥å¤ªç½‘ç›®æ ‡åœ°å€ï¼Œ2å­—èŠ‚çš„ä»¥å¤ªç½‘å¸§ç±»å‹</strong></p>
</blockquote>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“è¿›ç¨‹è°ƒç”¨<code>sendto()</code>ç³»ç»Ÿè°ƒç”¨æ—¶ï¼š</p>
<ol>
<li>å°†ç”¨æˆ·æ•°æ®æ‹·å…¥mbufé“¾è¡¨</li>
<li>æ·»åŠ UDP&#x2F;IPé¦–éƒ¨</li>
<li>æ·»åŠ ä»¥å¤ªç½‘é¦–éƒ¨ï¼Œéšåè¾“å‡º</li>
</ol>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424145058791.png" alt="image-20230424145058791"></p>
<h3 id="è¾“å…¥å¤„ç†"><a href="#è¾“å…¥å¤„ç†" class="headerlink" title="è¾“å…¥å¤„ç†"></a>è¾“å…¥å¤„ç†</h3><blockquote>
<p>è¾“å…¥å¤„ç†ä¸åˆšè°ˆåˆ°çš„è¾“å‡ºå¤„ç†ä¸åŒï¼Œå› ä¸ºè¾“å…¥æ—¶å¼‚æ­¥çš„ã€‚å…·ä½“æ¥è®²ï¼Œä»–æ˜¯é€šè¿‡ä¸€ä¸ªè¾“å…¥å®Œæˆçš„ä¸­æ–­ä½¿ä»¥å¤ªç½‘è®¾å¤‡é©±åŠ¨ç¨‹åºæ¥æ¥å—ä¸€ä¸ªè¾“å…¥åˆ†ç»„ï¼Œè€Œä¸æ˜¯é€šè¿‡è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚å†…æ ¸å¤„ç†è¿™ä¸ªè®¾å¤‡ä¸­æ–­ï¼Œå¹¶è°ƒåº¦è®¾å¤‡é©±åŠ¨ç¨‹åºè¿›å…¥è¿è¡ŒçŠ¶æ€ã€‚</p>
</blockquote>
<h4 id="ä»¥å¤ªç½‘è¾“å…¥"><a href="#ä»¥å¤ªç½‘è¾“å…¥" class="headerlink" title="ä»¥å¤ªç½‘è¾“å…¥"></a>ä»¥å¤ªç½‘è¾“å…¥</h4><p>å‡è®¾ä¸€ä¸ªæ­£å¸¸çš„æ¥å—å·²ç»å®Œæˆï¼Œä»¥å¤ªç½‘è®¾å¤‡é©±åŠ¨ç¨‹åºä¼šå¤„ç†è¿™ä¸ªä¸­æ–­ã€‚åœ¨ä¸‹å›¾çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ¥æ”¶äº†54ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°äº†mbufå½“ä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š20å­—èŠ‚çš„IPé¦–éƒ¨ï¼Œ8å­—èŠ‚çš„UDPé¦–éƒ¨ï¼Œ26å­—èŠ‚çš„æ•°æ®</p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424151929217.png" alt="image-20230424151929217"></p>
<p>å¯ä»¥çœ‹åˆ°å…¶ä¸­åˆ†é…äº†16å­—èŠ‚ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä½¿ç”¨ã€‚è¿™ä¸ªç©ºé—´æ˜¯åˆ†é…ç»™æ¥å£å±‚çš„é¦–éƒ¨ï¼Œå…¶ä»–æ•°æ®å­˜æ”¾åœ¨å‰©ä½™çš„84å­—èŠ‚ä¸­ã€‚</p>
<p>æ¥ç€è®¾å¤‡é©±åŠ¨ç¨‹åºä¼šæ ¹æ®ä»¥å¤ªç½‘å¸§ä¸­çš„ç±»å‹å­—æ®µæ¥å†³å®šè¿™ä¸ªåˆ†ç”±é‚£ä¸ªåè®®å±‚æ¥æ¥æ”¶ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°†ç”±IPè¾“å…¥ä¾‹ç¨‹è¿›è¡Œæ¥æ”¶ã€‚ä»è€Œmbufä¼šè¢«åŠ å…¥åˆ°IPè¾“å…¥é˜Ÿåˆ—å½“ä¸­ï¼Œå¦å¤–ä¼šäº§ç”Ÿä¸€ä¸ªè½¯ä¸­æ–­æ¥æ‰§è¡ŒIPè¾“å…¥ä¾‹ç¨‹ã€‚</p>
<h4 id="IPè¾“å…¥"><a href="#IPè¾“å…¥" class="headerlink" title="IPè¾“å…¥"></a>IPè¾“å…¥</h4><p>IPè¾“å…¥æ˜¯å¼‚æ­¥çš„ï¼Œé€šè¿‡è½¯ä¸­æ–­æ¥æ‰§è¡Œã€‚è¿™ä¸ªè½¯ä¸­æ–­ç”±æ¥å£å±‚æ¥æ”¶åˆ°IPæ•°æ®æŠ¥æ—¶è§¦å‘ã€‚IPå¤„ç†ä¾‹ç¨‹ä¼šå¾ªç¯å¤„ç†IPè¾“å…¥é˜Ÿåˆ—ä¸Šçš„æ¯ä¸€ä¸ªæ•°æ®æŠ¥ï¼Œå¹¶åœ¨æ•´ä¸ªé˜Ÿåˆ—å®Œæˆåè¿”å›ã€‚IPæ•°æ®æŠ¥å¤„ç†æµç¨‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>éªŒè¯IPé¦–éƒ¨æ ¡éªŒå’Œ</li>
<li>å¤„ç†IPé€‰é¡¹</li>
<li>éªŒè¯æ•°æ®æŠ¥ è¢«ä¼ é€’åˆ°æ­£ç¡®çš„ä¸»æœºï¼ˆé€šè¿‡æ¯”è¾ƒç›®çš„IPåœ°å€å’Œä¸»æœºIPåœ°å€ï¼‰</li>
<li>è½¬å‘æ•°æ®åŒ…ï¼ˆå½“ç³»ç»Ÿä¸ºè·¯ç”±å™¨ä¸”ç›®çš„åœ°å€ä¸ºå…¶ä»–IPæ—¶ï¼‰</li>
<li>å¦‚æœåˆ°è¾¾æœ€ç»ˆç›®çš„åœ°å€ï¼Œåˆ™ä¼šè°ƒç”¨ä¸‹ä¸€æ­¥è¾“å…¥ä¾‹ç¨‹ï¼ˆå¦‚TCPã€UDPã€ICMPåŠIGMPç­‰ï¼‰</li>
</ul>
<blockquote>
<p> åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å‡è®¾ä¸‹ä¸€æ­¥è¾“å…¥å¤„ç†ä¾‹ç¨‹ä¸ºUDP</p>
</blockquote>
<h4 id="UDPè¾“å…¥"><a href="#UDPè¾“å…¥" class="headerlink" title="UDPè¾“å…¥"></a>UDPè¾“å…¥</h4><p>UDPè¾“å…¥ä¾‹ç¨‹ä¼šéªŒè¯UDPé¦–éƒ¨ä¸­çš„å„å­—æ®µï¼Œç„¶åç¡®å®šæ˜¯å¦ä¸€ä¸ªè¿›ç¨‹æ¥æ”¶æ¬¡æ•°æ®æŠ¥ã€‚</p>
<blockquote>
<p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ¥æ”¶åˆ°æŒ‡å®šUDPç«¯å£çš„æ‰€æœ‰æ•°æ®æŠ¥ï¼Œæˆ–è®©å†…æ ¸æ ¹æ®æºä¸ç›®æ ‡IPåœ°å€ä¸ç›®æ ‡ç«¯å£å·æ¥é™åˆ¶æ•°æ®æŠ¥çš„æ¥æ”¶ã€‚</p>
</blockquote>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424155315099.png" alt="image-20230424155315099"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ‰çš„mbufè¢«æ’å…¥åˆ°äº†ä¸€ä¸ªæ–°çš„mbufä¸­ã€‚ç”±äºæˆ‘ä»¬çš„æ•°æ®æŠ¥éœ€è¦ä¼ ç»™è¿›ç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªæ–°çš„mbufåŒ…å«äº†å‘é€æ–¹çš„IPåœ°å€å’Œç«¯å£å·ï¼ˆä»IPé¦–éƒ¨ä¸­æ‹†åˆ†å‡ºæ¥ï¼‰ã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬å¯¹æ¯”å›¾ä¸­å³ä¾§æ”¾ç½®æ•°æ®çš„mbufå’Œä»¥å¤ªç½‘è¾“å…¥çš„mbufå¯ä»¥å‘ç°ï¼Œ<code>m_len</code>å’Œ<code>m_pkthdr.len</code> éƒ½å‡å°äº†28å­—èŠ‚(å³IPé¦–éƒ¨å’ŒUDPé¦–éƒ¨çš„éƒ¨åˆ†)ï¼Œ<code>m_data</code>æŒ‡å‘çš„åœ°å€ä¹Ÿå‡å°äº†28ï¼Œåªä¿ç•™äº†26å­—èŠ‚çš„dataæ•°æ®ã€‚</p>
<blockquote>
<p>é“¾è¡¨çš„ç¬¬ä¸€ä¸ªmbufçš„<strong>m_type</strong>ç±»å‹è¢«è®¾ç½®ä¸ºäº†<strong>MT_SONAME</strong>ï¼Œä¸”è¿™ä¸ªmbufæ˜¯ç”±æ’å£å±‚å»ºç«‹ï¼Œå°†è¿™äº›ä¿¡æ¯è¿”å›ç»™è°ƒç”¨ç³»ç»Ÿè°ƒç”¨recvfromå’Œrecvmsgçš„è¿›ç¨‹ä¸­ã€‚å³ä¾¿ç¬¬äºŒä¸ªmbufæœ‰ç©ºé—´å¯ä»¥ç”¨æ¥å­˜å‚¨æ’å£åœ°å€ç»“æ„(å‘é€æ–¹IPåœ°å€å’Œç«¯å£å·)ï¼Œä¹Ÿä¸èƒ½æ”¾ç½®åœ¨ä¸€èµ·ã€‚å› ä¸ºä¸¤ä¸ªmbufçš„ç±»å‹å¹¶ä¸ç›¸åŒï¼Œä¸€ä¸ªæ˜¯<strong>MT_SONAME</strong>ï¼Œä¸€ä¸ªæ˜¯<strong>MT_DATA</strong>ã€‚</p>
</blockquote>
<h4 id="è¿›ç¨‹è¾“å…¥"><a href="#è¿›ç¨‹è¾“å…¥" class="headerlink" title="è¿›ç¨‹è¾“å…¥"></a>è¿›ç¨‹è¾“å…¥</h4><p>å½“è¿›ç¨‹è°ƒç”¨<code>recvfrom()</code>æ—¶ï¼Œè¿›ç¨‹ä¼šåœ¨å†…æ ¸ä¸­ä¿æŒç¡çœ çŠ¶æ€ã€‚ç°åœ¨ï¼Œå†…æ ¸ä¼šå”¤é†’æˆ‘ä»¬çš„è¿›ç¨‹ï¼Œå¹¶æŠŠmbufä¸­çš„æ•°æ®å¤åˆ¶åˆ°ç¨‹åºçš„ç¼“å­˜ä¸­ã€‚ç„¶åé‡Šæ”¾æ‰è¿™äº›mbuf</p>
<blockquote>
<p>åœ¨è°ƒç”¨recvfromæ—¶ï¼Œæˆ‘ä»¬å°†ç¬¬5ã€6ä¸ªå‚æ•°è®¾ç½®ä¸º<strong>NULL</strong>ï¼Œè¡¨ç¤ºæˆ‘ä»¬å¹¶ä¸å…³å¿ƒå‘é€æ–¹çš„IPåœ°å€å’ŒUDPç«¯å£å·ï¼Œæ­¤æ—¶recvformåªä¼šè¿”å›ç¬¬äºŒä¸ªmbufçš„dataã€‚</p>
</blockquote>
<h3 id="ä¸­æ–­çº§åˆ«"><a href="#ä¸­æ–­çº§åˆ«" class="headerlink" title="ä¸­æ–­çº§åˆ«"></a>ä¸­æ–­çº§åˆ«</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºæ˜¯8ä¸ªç¡¬ä»¶åŠè½¯ä»¶ä¸­æ–­çš„ä¼˜å…ˆçº§ã€‚åˆ’çº¢çº¿çš„éƒ¨åˆ†ä¸ºæˆ‘ä»¬ä¹‹å‰è°ˆåˆ°çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼š<strong>splnet(è½¯ä¸­æ–­ï¼Œæ‰§è¡Œåè®®å±‚ä»£ç )<strong>ï¼Œ</strong>splimp(ç¡¬ä¸­æ–­æ‰§è¡Œæ¥å£å±‚ä»£ç )</strong></p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424175810425.png" alt="image-20230424175810425"></p>
<h2 id="ç¬¬äºŒç« -å­˜å‚¨å™¨å­˜å‚¨"><a href="#ç¬¬äºŒç« -å­˜å‚¨å™¨å­˜å‚¨" class="headerlink" title="ç¬¬äºŒç«  å­˜å‚¨å™¨å­˜å‚¨"></a>ç¬¬äºŒç«  å­˜å‚¨å™¨å­˜å‚¨</h2><h3 id="mbufåˆ†ç±»"><a href="#mbufåˆ†ç±»" class="headerlink" title="mbufåˆ†ç±»"></a>mbufåˆ†ç±»</h3><p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424181654748.png" alt="image-20230424181654748"></p>
<p>ç”±ä¸Šå›¾æ‰€ç¤ºï¼Œæ ¹æ®mbuf<code>flags</code>åŸŸï¼Œæˆ‘ä»¬å¯ä»¥å°†mbufåˆ†ä¸º4ç±»ï¼š</p>
<ul>
<li><strong>flags &#x3D;&#x3D; 0</strong>ï¼ŒåªåŒ…å«dataï¼Œä¸”dataæœ€å¤§ä¸º108 byte</li>
<li><strong>flags &#x3D;&#x3D; M_PKTHDR</strong> ï¼ŒåŒ…å«8 byteåˆ†ç»„å¤´éƒ¨ï¼Œ dataæœ€å¤§ä¸º100 byte</li>
<li><strong>flags &#x3D;&#x3D; M_EXT</strong>ï¼ŒåŒ…å«2048byteçš„é¢å¤–ç©ºé—´ï¼Œä¸”æ•°æ®æœ€å°‘ä¸º208byte</li>
<li><strong>flags &#x3D;&#x3D; M_PKTHDR | M_EXT</strong>ï¼Œåœ¨é¢å¤–ç©ºé—´çš„åŸºç¡€ä¸Šå¤šäº†åˆ†ç»„å¤´éƒ¨ï¼Œä¸”æ•°æ®æœ€å°é•¿åº¦ä¸º208byte</li>
</ul>
<blockquote>
<p>é˜´å½±éƒ¨åˆ†ä¸ºä¸ä½¿ç”¨çš„éƒ¨åˆ†</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåä¸¤ç±»çš„mufåˆå¤šäº†ä¸‰ç§åŸŸï¼š</p>
<ul>
<li><code>m_ext.ext_buf</code>ï¼ŒæŒ‡å‘é¢å¤–ç©ºé—´çš„èµ·å§‹åœ°å€ï¼ˆm_dataæŒ‡å‘çš„æ˜¯ç¼“å­˜çš„èµ·å§‹ï¼‰</li>
<li><code>m_ext.ext_free</code>ï¼Œåœ¨Net&#x2F;3ä¸­ä¸ä½¿ç”¨</li>
<li><code>m_ext.ext_size</code>ï¼Œé¢å¤–ç©ºé—´çš„å¤§å°ï¼Œä¸€èˆ¬ä¸º1024æˆ–2048ï¼Œæœ¬ä¹¦ä»¥2048ä¸ºä¸»mub</li>
</ul>
<h3 id="ç®€å•çš„mbufå®å’Œå‡½æ•°"><a href="#ç®€å•çš„mbufå®å’Œå‡½æ•°" class="headerlink" title="ç®€å•çš„mbufå®å’Œå‡½æ•°"></a>ç®€å•çš„mbufå®å’Œå‡½æ•°</h3><h4 id="MGETå®"><a href="#MGETå®" class="headerlink" title="MGETå®"></a>MGETå®</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MGET(m, how, type) &#123; \</span><br><span class="hljs-meta">	MALLOC((m), struct mbuf *, MSIZE, mbtypes [type], (how)); \</span><br><span class="hljs-meta">	<span class="hljs-keyword">if</span>(m)&#123;\</span><br><span class="hljs-meta">		(m)-&gt;m_type = (type); \</span><br><span class="hljs-meta">		MBUFLOCK (mbstat.m_mtypes [type]++;) \</span><br><span class="hljs-meta">		(n)-&gt;m_next = (struct mbuf * )NULL; \</span><br><span class="hljs-meta">		(m)-&gt;m_nextpkt = (struct mbuf *)NULL; \</span><br><span class="hljs-meta">		(m) -&gt;m_data = (m)-&gt;m_dat; \</span><br><span class="hljs-meta">		(m)-&gt;m_flags = 0; \</span><br><span class="hljs-meta">	&#125; <span class="hljs-keyword">else</span> \</span><br><span class="hljs-meta">		(m) = m_retry((how)ï¼Œ(type)); \</span><br></code></pre></td></tr></table></figure>

<p> è¿™é‡Œå°±ä¸åšæºç ä¸Šè¯¦ç»†è§£é‡Šï¼Œè‡ªå·±çœ‹åº”è¯¥èƒ½æ‡‚ã€‚åªç¨å¾®è¯´å‡ ä¸ªç‚¹ï¼š</p>
<ul>
<li><code>MBUFLOCK</code>å®æ˜¯ç”¨æ¥ä¿è¯æ‰§è¡Œ<code>mbstat.m_mtypes[type]++</code>çš„ä¼˜å…ˆçº§ï¼Œé˜²æ­¢+1æ—¶è¢«æ‰“æ–­</li>
<li><code>m-&gt;data = m-&gt;dat</code>æ˜¯è®©dataæŒ‡å‘ç¼“å­˜åŒºåŸŸçš„å¼€å§‹åœ°å€</li>
<li>elseåˆ†æ”¯é‡Œé¢æ˜¯mallocåˆ†é…å¤±è´¥æ—¶çš„å¤„ç†</li>
</ul>
<blockquote>
<p>mbstat æ˜¯ä¸€ä¸ªç”¨æ¥ç®¡ç†mbufçš„å…¨å±€å˜é‡ï¼Œå‰é¢æˆ‘å¹¶æ²¡æœ‰æåˆ°ã€‚æ˜¯å› ä¸ºæˆ‘è§‰å¾—è¿™ä¸ªä¸œè¥¿å¯èƒ½ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œæ²¡è¯¦ç»†å»çœ‹ğŸ˜€</p>
</blockquote>
<h4 id="m-getå‡½æ•°"><a href="#m-getå‡½æ•°" class="headerlink" title="m_getå‡½æ•°"></a>m_getå‡½æ•°</h4> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> mbuf* <span class="hljs-title function_">m_get</span><span class="hljs-params">(nowait, type)</span><br><span class="hljs-type">int</span> 	nowait, type;<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mbuf</span> *<span class="hljs-title">m</span>;</span><br>    <br>    MGET(m, nowait, type);<br>    retrun (m);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ²¡ä»€ä¹ˆä¸œè¥¿ï¼Œå°±æ˜¯MGETå®å¥—äº†ä¸ªå‡½æ•°å¤–å¥—ã€‚nowaitçš„å€¼ä¸ºM_WAITæˆ–M_DONTWAITï¼Œå–å†³äºåœ¨å­˜å‚¨å™¨ä¸å¯ç”¨æ—¶æ˜¯å¦ç­‰å¾…ã€‚</p>
<h4 id="m-retryå‡½æ•°"><a href="#m-retryå‡½æ•°" class="headerlink" title="m_retryå‡½æ•°"></a>m_retryå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> mbuf* <span class="hljs-title function_">m_retry</span><span class="hljs-params">(i, t)</span><br><span class="hljs-type">int</span> 	i, t;<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mbuf</span> *<span class="hljs-title">m</span>;</span><br>    <br>    m_relaim();<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> m_retry(i,t)	(struct mbuf *)0</span><br>    MGET(m, nowait, type);<br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> m_retry</span><br>    retrun (m);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ˜¯MGETå®çš„elseåˆ†æ”¯æ‰§è¡Œçš„å‡½æ•°ï¼Œé€šè¿‡<code>m_relaim()</code>è¯•å›¾è…¾å‡ºä¸€éƒ¨åˆ†ç©ºé—´ï¼Œç„¶åå†æ¬¡å°è¯•MGET</p>
<h4 id="m-devgetå‡½æ•°"><a href="#m-devgetå‡½æ•°" class="headerlink" title="m_devgetå‡½æ•°"></a>m_devgetå‡½æ•°</h4><p>å½“æ¥æ”¶åˆ°ä»¥å¤ªç½‘å¸§æ—¶ï¼Œè®¾å¤‡é©±åŠ¨ç¨‹åºè°ƒç”¨å‡½æ•°<code>m_devget()</code>åˆ›å»ºmbufæ¥æ¥å—æ•°æ®ï¼Œæ ¹æ®æ•°æ®é•¿åº¦ä¸åŒï¼Œä¼šå½¢æˆå››ç§ç±»å‹çš„mbufé“¾è¡¨,å¦‚ä¸‹é¢æ‰€ç¤ºï¼š</p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424194426443.png" alt="image-20230424194426443"></p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424194444638.png" alt="image-20230424194444638"></p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424194434240.png" alt="image-20230424194434240"></p>
<h4 id="mtodå’Œdtomå®"><a href="#mtodå’Œdtomå®" class="headerlink" title="mtodå’Œdtomå®"></a>mtodå’Œdtomå®</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span>	mtod(m, t)	((t) ((m)-&gt;m_data) )</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>	dtom(x)	((struct mbuf *) ((int) (x) &amp; ~ (MSIZE-1)))</span><br></code></pre></td></tr></table></figure>

<p><code>mtod()</code>å®å¯ä»¥ç›´æ¥ç†è§£æˆ<strong>mbuf to data</strong>ï¼Œå³è¿”å›mbufä¸­çš„m_dataæŒ‡é’ˆï¼Œä¸è¿‡é¢å¤–åšäº†ç±»å‹è½¬æ¢</p>
<p> <code>dtom()</code>å¯ä»¥ç†è§£ä¸º<strong>data to mbuf</strong>ï¼Œå³é€šè¿‡dataæŒ‡é’ˆè¿”å›æŒ‡å‘mbufçš„æŒ‡é’ˆ</p>
<blockquote>
<p>dtom()å®é™…åŸç†ä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒMSIZEä¸º128ï¼Œé‚£ä¹ˆ~(MSIZE-1)å…¶å®å°±æ˜¯0xffffff80ï¼Œå¯ä»¥æ˜æ˜¾çœ‹åˆ°byteçš„äºŒè¿›åˆ¶å½¢å¼ä½ 1000 0000é€šè¿‡æ¸…ç†ä½ä½æ¥æ‰¾åˆ°mbufçš„èµ·å§‹åœ°å€ã€‚ç”±äºæœ¬ä¹¦å…¨æ˜¯32ä½çš„ç³»ç»Ÿï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä¹Ÿç”¨çš„æ˜¯32ä½çš„åœ°å€ä¸¾ä¾‹ã€‚</p>
</blockquote>
<p>çŸ¥é“<code>dtom()</code>çš„åŸç†ï¼Œå¾ˆå®¹æ˜“å°±å‘ç°å…¶åªé€‚ç”¨äºä¸å«é¢å¤–æ‰©å®¹çš„mbufç»“æ„ï¼Œæ­¤æ—¶éœ€è¦<code>m_pullup</code>å¤„ç†</p>
<h4 id="m-pullup"><a href="#m-pullup" class="headerlink" title="m_pullup"></a>m_pullup</h4><h5 id="ä½œç”¨1"><a href="#ä½œç”¨1" class="headerlink" title="ä½œç”¨1"></a>ä½œç”¨1</h5><p>å½“æ•°æ®æŠ¥é•¿åº¦å°äºåè®®é¦–éƒ¨å¤§å°æ—¶ï¼Œ<code>m_pullup</code>ä¼šå°†å‰Nä¸ªå­—èŠ‚æ•°æ®é‡ç»„åœ¨ç¬¬ä¸€ä¸ªmbufä¸­ï¼Œè¯•å›¾æ¢å¤æ­£å¸¸çš„åè®®é¦–éƒ¨ã€‚Nä¸ºä¼ å…¥å‚æ•°ï¼Œä½†æ˜¯å½“mbufé“¾è¡¨ä¸Šæ•°æ®æ€»é•¿åº¦å°äºNæ—¶ï¼Œå‡½æ•°å°†å¤±æ•ˆï¼Œè¯¥æ•°æ®æŠ¥ä¼šè¢«ä¸¢å¼ƒã€‚</p>
<h5 id="ä½œç”¨2"><a href="#ä½œç”¨2" class="headerlink" title="ä½œç”¨2"></a>ä½œç”¨2</h5><p>å°±æ˜¯åˆšåˆšè°ˆåˆ°çš„<code>dtom()</code>é—®é¢˜ï¼Œå½“mbufä¸­æœ‰æ‰©å®¹åœ°å€æˆ–è€…è¯´æ•°æ®åœ¨â€œç°‡â€ä¸­å­˜æ”¾æ—¶ï¼Œè¿™é‡Œ<code>m_pullup</code>ï¼Œå°†ä¼šæ–°å»ºä¸€ä¸ªmbufæ’å…¥é“¾è¡¨å¤´ï¼Œå¹¶æŠŠç°‡çš„å‰40ä¸ªbyteæ‹·è´è¿‘æ–°çš„mbufé“¾è¡¨å¤´å†…ã€‚</p>
<blockquote>
<p>40ä¸ªå­—èŠ‚æ˜¯å› ä¸ºæœ€å¤§çš„åè®®é¦–éƒ¨ä¸º40ï¼ˆ20 IPé¦–éƒ¨+20 TCPé¦–éƒ¨ï¼‰ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åœ¨åç»­ä¼ ç»™é«˜å±‚åè®®å¤„ç†æ—¶ï¼Œå¯ä»¥æ­£å¸¸å¤„ç†ã€‚</p>
<p>ä¸‹å›¾2-17ä¸ºå¤„ç†å‰ï¼Œ2-18ä¸ºå¤„ç†åã€‚å¦å¤–éœ€è¦æ³¨æ„åˆ°ï¼Œå¤„ç†åçš„m_dataæŒ‡é’ˆæŒ‡å‘äº†ç°‡å†…å»é™¤40byteä¹‹åçš„ä½ç½®ï¼ŒéªŒè¯äº†æˆ‘ä»¬ä¹‹å‰è°ˆåˆ°çš„m_dataæŒ‡å‘çš„æ˜¯æ•°æ®çš„èµ·å§‹ï¼Œè€Œä¸æ˜¯ç¼“å­˜åŒºåŸŸçš„èµ·å§‹ã€‚</p>
</blockquote>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424202823136.png" alt="image-20230424202823136"></p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424202834314.png" alt="image-20230424202834314"></p>
<p>å¦å¤–éœ€è¦æ³¨æ„ï¼ŒTCPä¸ä½¿ç”¨<code>m_pullup()</code>ï¼Œè€Œæ˜¯é‡‡å–å¦å¤–ä¸åŒçš„æŠ€æœ¯</p>
<h3 id="è”ç½‘æ•°æ®ç»“æ„å°ç»“"><a href="#è”ç½‘æ•°æ®ç»“æ„å°ç»“" class="headerlink" title="è”ç½‘æ•°æ®ç»“æ„å°ç»“"></a>è”ç½‘æ•°æ®ç»“æ„å°ç»“</h3><blockquote>
<p>ä¸ªäººæ„Ÿè§‰å‰é¢å“ªäº›è¯¦ç»†åˆ†æå·²ç»å·®ä¸å¤šäº†ï¼Œè¿™æ•°æ®ç»“æ„è‡ªå·±ä¹Ÿåº”è¯¥èƒ½ç”»å‡ºæ¥ğŸ˜ï¼Œå°±æ”¾ä¸¤å¼ å›¾çœ‹çœ‹å°±å¥½</p>
</blockquote>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424203817974.png" alt="image-20230424203817974"></p>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424203829722.png" alt="image-20230424203829722"></p>
<h3 id="m-copyå’Œç°‡å¼•ç”¨è®¡æ•°"><a href="#m-copyå’Œç°‡å¼•ç”¨è®¡æ•°" class="headerlink" title="m_copyå’Œç°‡å¼•ç”¨è®¡æ•°"></a>m_copyå’Œç°‡å¼•ç”¨è®¡æ•°</h3><blockquote>
<p>è¿™ä¸ªpartæ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„éƒ¨åˆ†ï¼Œä½†æµç¨‹ç›¸å¯¹æ¥è¯´ä¹Ÿæ›´å¤æ‚ä¸€äº›</p>
</blockquote>
<p>è¿™é‡Œæˆ‘ä»¬å‡è®¾ä¸€ä¸ªä¾‹å­ï¼Œä¸€ä¸ªç¨‹åºæƒ³æŠŠå…±4096byteå†™å…¥åˆ°TCPæ’å£å½“ä¸­ï¼Œä¸”TCPä¼ è¾“çš„æœ€å¤§æŠ¥æ–‡å¤§å°ä¸º1460ã€‚é‚£ä¹ˆåŸºæœ¬æµç¨‹å¦‚ä¸‹:</p>
<ol>
<li>å…ˆæŠŠå‰2048ä¸ªbyteæ”¾å…¥ä¸€ä¸ªç°‡å†…ï¼Œå¦‚ä¸‹å›¾<img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424205327832.png" alt="image-20230424205327832"></li>
<li>æ–°å»ºä¸€ä¸ªmbufä½œä¸ºå‘é€å‡ºå»çš„mbufåˆ†ç»„é¦–éƒ¨ï¼ˆå·¦ä¸‹ï¼‰ï¼Œå†å»ºä¸€ä¸ªmbufä¸æ­¥éª¤1å»ºç«‹çš„mbufå…±äº«ç°‡ï¼ˆå³ä¸‹ï¼‰ï¼Œå¹¶è®¾ç½®m_lenä¸º1460ï¼Œè¡¨ç¤ºåªå–å‰é¢1460ï¼Œå¦‚å›¾<img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424205805136.png" alt="image-20230424205805136"></li>
<li>å°†è¿™1460çš„æ•°æ®ä¼ è¾“å‡ºå»ï¼Œç„¶åé‡Šæ”¾æ‰mbuf</li>
<li>æ–°å»ºä¸€ä¸ªmbufï¼ˆå³ä¸Šï¼‰ç”¨äºå­˜æ”¾å2048çš„byteï¼ŒåŒæ­¥éª¤2æ–°å»ºbufé“¾è¡¨ï¼Œä¸è¿‡é“¾è¡¨ç¬¬2ä¸ªmbufæŒ‡å‘ä¹‹å‰æœªç”¨å®Œçš„ç°‡ååŠéƒ¨åˆ†ï¼Œç¬¬ä¸‰ä¸ªmbufæŒ‡å‘æ–°çš„2048<img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424210301395.png" alt="image-20230424210301395"></li>
<li>ä¸æ–­é‡å¤ç±»ä¼¼ä¸Šè¿°æ“ä½œï¼Œé€šè¿‡å…±äº«ç°‡ï¼Œå°†æ‰€æœ‰æ•°æ®ä¼ è¾“å‡ºå»</li>
</ol>
<blockquote>
<p>ç°‡å¼•ç”¨è®¡æ•°ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç°‡åŒæ—¶è¢«å‡ ä¸ªmbufæŒ‡å‘ã€‚æ¯å½“é‡Šæ”¾ä¸€ä¸ªmbufï¼Œè¯¥mbufæ‰€æŒ‡å‘çš„ç°‡çš„å¼•ç”¨è®¡æ•°-1ï¼Œå½“ä¸”ä»…å½“ç°‡çš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œç°‡å¯ä»¥è¢«é‡Šæ”¾ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢åœ¨å…±äº«ç°‡æ—¶ï¼Œä¸Šè¿°æ“ä½œä¸­çš„é‡Šæ”¾mbufå¯èƒ½ä¼šå¯¼è‡´é‡Šæ”¾æ‰å…±äº«çš„ç°‡è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p>
</blockquote>
<h2 id="ç¬¬ä¸‰ç« -æ¥å£å±‚"><a href="#ç¬¬ä¸‰ç« -æ¥å£å±‚" class="headerlink" title="ç¬¬ä¸‰ç«  æ¥å£å±‚"></a>ç¬¬ä¸‰ç«  æ¥å£å±‚</h2><h3 id="ifnetç»“æ„"><a href="#ifnetç»“æ„" class="headerlink" title="ifnetç»“æ„"></a>ifnetç»“æ„</h3><p>ç»“æ„ifnetä¸­åŒ…å«æ‰€æœ‰æ¥å£çš„é€šç”¨ä¿¡æ¯ï¼Œæ¯ä¸ªç½‘ç»œè®¾å¤‡æ‹¥æœ‰ç‹¬ç«‹çš„ifnetç»“æ„ã€‚ifnetç»“æ„æœ‰ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«è¿™ä¸ªè®¾å¤‡çš„ä¸€ä¸ªæˆ–å¤šä¸ªåè®®åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifnet</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifnet</span> *<span class="hljs-title">if_next</span>;</span>		<span class="hljs-comment">/* a11 struct ifnets are chained */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifaddr</span> *<span class="hljs-title">if_addrlist</span>;</span> <span class="hljs-comment">/* linked list of addresses per if */</span><br>    <span class="hljs-type">char</span> *if_name;				<span class="hljs-comment">/* name, e.g. &#x27;le&#x27; or &#x27;lo&#x27; */</span><br>    <span class="hljs-type">short</span> if_unit;				<span class="hljs-comment">/* sub-unit for lower level driver */</span><br>    u_short if_index;			<span class="hljs-comment">/* numeric abbreviation for this if */</span><br>    <span class="hljs-type">short</span> if_flags ;			<span class="hljs-comment">/* Figure 3.7 */</span><br>    <span class="hljs-type">short</span> if_timer ;			<span class="hljs-comment">/* time &#x27;ti1 if_watchdog called */</span><br>    <span class="hljs-type">int</span> if_pcount;				<span class="hljs-comment">/* number of promiscuous listeners */</span><br>    <span class="hljs-type">caddr_t</span> if_bpf;				<span class="hljs-comment">/* packet filter structure */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">if_</span> _<span class="hljs-title">data</span> &#123;</span><br>        <span class="hljs-comment">/* generic interface information */</span><br>        u_char ifi_type;		<span class="hljs-comment">/* Figure 3.9 */</span><br>        u_char ifi_addr1en;		<span class="hljs-comment">/* media address 1ength */</span><br>        u_char ifi_harlen;		<span class="hljs-comment">/* media header length */</span><br>        u_1ong ifi_mtu;			<span class="hljs-comment">/* maximum transmission unit */</span><br>        u_long ifi_metric ;		<span class="hljs-comment">/* lrouting metric (external on1y) */</span><br>        u_1ong ifi_baudrate;	<span class="hljs-comment">/* linespeed */</span><br>        <br>        			<span class="hljs-comment">/* other ifner members */</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> if_mtu if_data.ifi_mtu</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> if_type if_data.ifi_type</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> if_addrlen if_data.ifi_addrlen</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> if_hdrlen if_data.ifi_hdrlen</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> if_metric if_data.ifi_metric</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> if_baudrate if_data.ifi_baudrate</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰æ³¨é‡Šï¼Œå°±ä¸ç”¨æˆ‘è§£é‡Šäº†å§ğŸ˜­ï¼Œå›°æ­»äº†è¦ï¼Œè¿™äº›bä¸œè¥¿èƒ½è€ƒä»€ä¹ˆï¼Œå“¥ä»¬ä¹ŸèƒŒä¸ä¸‹æ¥å•Š</p>
</blockquote>
<ul>
<li>if_next å°†æ‰€æœ‰ifneté“¾æ¥ä¸ºä¸€ä¸ªå•é“¾è¡¨</li>
<li>if_addrlist æŒ‡å‘<code>ifaddr&#123;&#125;</code>ç»“æ„åˆ—è¡¨ï¼Œæ¯ä¸ª<code>ifaddr&#123;&#125;</code>ä¸ä¸€ä¸ªåè®®ç›¸å¯¹åº”</li>
<li>if_name ç”¨äºæ ‡è¯†æ¥å£çš„ç±»å‹</li>
<li>if_unit ç”¨äºæ ‡è¯†å¤šä¸ªç›¸åŒç±»å‹çš„å®ä¾‹</li>
<li>if_indexåœ¨å†…æ ¸ä¸­å”¯ä¸€è¡¨ç¤ºè¿™ä¸ªæ¥å£</li>
<li>if_flagsè¡¨æ˜æ¥å£çš„æ“ä½œçŠ¶æ€å’Œå±æ€§</li>
<li>if_timerä»¥ç§’ä¸ºå•ä½è®°å½•æ—¶é—´</li>
<li>if_pcountå’Œif_bpfï¼Œæ”¯æŒBSDåˆ†ç»„è¿‡æ»¤å™¨</li>
</ul>
<h3 id="ifaddrç»“æ„"><a href="#ifaddrç»“æ„" class="headerlink" title="ifaddrç»“æ„"></a>ifaddrç»“æ„</h3><p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424220517917.png" alt="image-20230424220517917"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifaddr</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifaddr</span> *<span class="hljs-title">ifa_next</span>;</span>			<span class="hljs-comment">/* next address for interface */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifnet</span> *<span class="hljs-title">ifa_ifp</span>;</span>				<span class="hljs-comment">/* back-pointer to interface */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> *<span class="hljs-title">ifa_addr</span> ;</span> 		<span class="hljs-comment">/* address of interface */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> *<span class="hljs-title">ifa_dstaddr</span> ;</span>		<span class="hljs-comment">/* other end of p-to-p link */</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> ifa_broadaddr ifa_dstaddr	<span class="hljs-comment">/* broadcast address interface */</span></span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span>* <span class="hljs-title">ifa_netmask</span>;</span>		<span class="hljs-comment">/* used to determine subnet */</span><br>    <span class="hljs-type">void</span> (*ifa_rtrequest) ();			<span class="hljs-comment">/* check or clean routes */</span><br>    u_short ifa_f1ags;					<span class="hljs-comment">/*mostly rt_ flags for cloning */</span><br>    <span class="hljs-type">short</span> ifa_refcnt;					<span class="hljs-comment">/* references to this structure */</span><br>    <span class="hljs-type">int</span> ifa_metric;						<span class="hljs-comment">/* cost for this interface */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ„Ÿè§‰è¿™ä¸¤ä¸ªç»“æ„åªè¦ææ‡‚å›¾å°±å·®ä¸å¤šäº†å§ğŸ˜­</p>
</blockquote>
<h3 id="sockaddr"><a href="#sockaddr" class="headerlink" title="sockaddr"></a>sockaddr</h3><p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424221919519.png" alt="image-20230424221919519"></p>
<blockquote>
<p>çœ‹çœ‹å›¾å·®ä¸å¤šå¾—äº†ï¼Œè¿™bè¯¾çœŸè¯¥æ­»å•ŠğŸ˜…</p>
</blockquote>
<h3 id="if-attach"><a href="#if-attach" class="headerlink" title="if_attach"></a>if_attach</h3><blockquote>
<p>ç”¨æ¥å®Œæˆifnetç»“æ„çš„åˆå§‹åŒ–å’Œæ­å»ºï¼Œç¬¬ä¸‰ç« æ˜¯çœŸé€†å¤©ï¼Œå·®ä¸å¤šå¾—äº†</p>
</blockquote>
<p><img src="/img/article/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%A4%8D%E4%B9%A0.assets/image-20230424222838348.png" alt="image-20230424222838348"></p>
<p><code>if_attach</code>è¢«è°ƒç”¨äº†ä¸‰æ¬¡: ä»¥ä¸€ä¸ª<code>le_softc</code>ç»“æ„ä¸ºå‚æ•°ä»<code>leattach</code>è°ƒç”¨ï¼Œä»¥ä¸€ä¸ª<code>sl_softc</code>ç»“æ„ä¸ºæ•°ä»<code>slattach</code>è°ƒç”¨ï¼Œä»¥ä¸€ä¸ªé€šç”¨<code>ifnet</code>ç»“æ„ä¸ºå‚æ•°ä»<code>loopattach</code>è°ƒç”¨ã€‚æ¯æ¬¡è°ƒç”¨æ—¶ï¼Œå®ƒå‘ifnetåˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªçš„<code>ifnet</code>ç»“æ„ï¼Œä¸ºè¿™ä¸ªæ¥å£åˆ›å»ºä¸€ä¸ªé“¾è·¯å±‚<code>ifaddr</code>ç»“æ„(åŒ…å«ä¸¤ä¸ª<code>sockaddr_dl</code>ç»“æ„)ï¼Œå¹¶ä¸”åˆå§‹åŒ–<code>ifnet_addrs</code>æ•°ç»„ä¸­çš„ä¸€é¡¹ã€‚</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ç½‘ç»œåè®®æ ˆCH1-CH3</div>
      <div>http://loora1n.github.io/2023/04/24/ç½‘ç»œåè®®æ ˆå¤ä¹ /</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Loora1N</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´4æœˆ24æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/25/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88CH4%E5%8F%8ACH6/" title="ç½‘ç»œåè®®æ ˆCH4åŠCH6">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ç½‘ç»œåè®®æ ˆCH4åŠCH6</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/31/%E3%80%90Linux%20kernel%E5%85%A5%E9%97%A8%E3%80%91%E5%86%85%E6%A0%B8%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95/" title="ã€kernelã€‘å†…æ ¸æœ¬åœ°è°ƒè¯•å…¥é—¨">
                        <span class="hidden-mobile">ã€kernelã€‘å†…æ ¸æœ¬åœ°è°ƒè¯•å…¥é—¨</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments">
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'loora1n/comment');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/Loora1N" target="_blank" rel="nofollow noopener"><span>Loora1N</span></a> <i class="iconfont icon-love"></i> <a href="https://space.bilibili.com/33242548?spm_id_from=333.1007.0.0" target="_blank" rel="nofollow noopener"><span>é·ºé›¨å›</span></a>
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  
</div>

  
  
  
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/03/2022 00:00:00");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "ğŸš€runningğŸš€ for&nbsp"+dnum+"&nbspdays";  //æ­¤æ¬¡è‡ªå®šä¹‰æ˜¾ç¤ºå†…å®¹
      document.getElementById("times").innerHTML = hnum + "&nbsphr&nbsp" + mnum + "&nbspmin&nbsp" + snum + "&nbspsec";
  }  //æ­¤æ¬¡è‡ªå®šä¹‰æ˜¾ç¤ºå†…å®¹
  setInterval("createtime()",250);
  </script>   
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>







  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiantiao.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/love.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/caidai.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
